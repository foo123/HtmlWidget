/**
*
*   ModelViewForm.js
*   Declarative MV Form building, rendering, validation 
*   @dependencies: jQuery, ModelView
*   @version: 0.6
*
*   https://github.com/foo123/modelview.js
*   https://github.com/foo123/modelview-form.js
*
**/
!function(e,t,r){"use strict";function a(e){return e.replace(k,".$1").replace(x,"")}function i(e){return"data-mvform-"+e}function o(e,t){return t.checked}function s(e){var t;return e.checked?e.value:(t=e.getAttribute("data-else"))?t:""}function n(e){return!!e&&e.length}function l(e,t){t=t||[];var r,a,o,s,n,l,d,u="";for((r=e.attr(i("selected-multiple")))?(e.removeAttr(i("selected-multiple")),r=r.split(",")):(r=e.attr(i("selected")))?e.removeAttr(i("selected")):r=e.val(),a=0,o=t.length;o>a;a++)s=t[a],N(s)?(n=s.key,l=s.value):(n=s,l=s),u+='<option value="'+n+'">'+l+"</option>";return d=e.children("optgroup"),d=d.length?d.eq(0):e,d.children("option:not(.default)").remove(),d.append(u),e.val(r),e}function d(e,r){r=r||[];var a,i,o,s,n,l=t("#"+e.attr("list")),d="";for(a=0,i=r.length;i>a;a++)o=r[a],N(o)?(s=o.key,n=o.value):(s=o,n=o),d+='<option value="'+s+'">'+n+"</option>";return l.html(d),e}function u(e,r){var o=r.$view.$model,s=o.id+".",n=!1,d={};e.each(function(){var e,r,o,l,u=t(this),c=u.attr("name");c&&(e=a(c),s===e.slice(0,s.length)&&(e=e.slice(s.length),l=u.attr(i("ajax-options")),r=u.attr(i("key")),o=u.attr(i("ajax-key")),o||(o=r),o&&r&&l&&(d[r]={key:o,model_key:r,options:l,$el:u},n=!0)))}),n&&(o.on("change",function(e,t){var a,i;t.key&&d[h](t.key)&&(i=d[t.key],a={},a[i.key]=o.get(i.model_key),i.$el.addClass("mvform-progress"),r.trigger("before-ajax-options",i),f.doGET(i.options,a,function(e,t){l(i.$el,t||[]).removeClass("mvform-progress").trigger("change"),r.trigger("after-ajax-options",i)}))}),o.notify($(d),"change"))}function c(e,r){var o=r.$view.$model,s=o.id+".",n={},l=!1,u=2,c={},m=6e4,v=200;e.each(function(){var e,r,o,d,u=t(this),m=u.attr("name");m&&(e=a(m),s===e.slice(0,s.length)&&(e=e.slice(s.length),o=u.attr(i("ajax-suggest")),r=u.attr(i("ajax-key")),r||(r=e),d=S("suggestlist"),u.after('<datalist id="'+d+'"></datalist>'),u.attr("list",d),n[m]={key:e,ajax_key:r,suggest:o,stop_typing:0,suggesting:!1,$el:u},c[e]={},l=!0))}),l&&r.$form.on("keypress","input["+i("ajax-suggest")+"]",function(){var e,t=this;t.name&&n[h](t.name)&&(e=n[t.name],e.stop_typing=(new Date).getTime()+v,setTimeout(function(){var a,i,o,s,n=(new Date).getTime();if(!(e.stop_typing>n||(s=I(t.value||""),s.length<u)))if(i=null,o=c[e.key],o[h](s)&&(o[s].expires<n?i=o[s].suggestions:delete o[s]),null!==i)d(e.$el,i);else{if(e.suggesting)return;e.suggesting=!0,a={},a[e.ajax_key]=s,e.$el.addClass("mvform-progress"),r.trigger("before-ajax-suggest",e),f.doGET(e.suggest,a,function(t,a){e.suggesting=!1,i=a||[],o[s]={expires:(new Date).getTime()+m,suggestions:i},d(e.$el,i).removeClass("mvform-progress"),r.trigger("after-ajax-suggest",e)})}},v+100))})}function m(e,r,l){var d=r.id+".",u={};e.each(function(){var e,c,m,v,f,g,p,$,b,N,w,k,x,I,D,R,_,C=t(this),L=C.attr("name"),V=!1;if(L&&!u[L]&&(e=a(L),d===e.slice(0,d.length))){if(e=e.slice(d.length),f=C.val()||"",g="",b=(C.attr("type")||"")[E](),x="radio"===b||"checkbox"===b,N=!!C.attr("required"),w=!!C.attr(i("required")),I=C.attr("data-else"),D=!!I,V="checkbox"===b&&A.test(L),C.attr("id")||C.attr("id",S(e.split(".").join("_"))),$=C.attr(i("type"))||b)switch($=$[T]()){case"NUMBER":case"INTEGER":case"INT":r.types[e]=M.INT,f=M.INT(f)||0,g=0,x&&!V&&D&&(g=M.INT(I)||0);break;case"DATE":case"TIME":case"DATETIME":case"EMAIL":case"URL":case"TEXT":case"STRING":case"STR":r.types[e]=M.STR,f=M.STR(f)||"",g="",x&&!V&&D&&(g=M.STR(I)||"");break;case"BOOLEAN":case"BOOL":r.types[e]=M.BOOL,f=M.BOOL(f)||!1,g=!f,x&&!V&&D&&(g=M.BOOL(I));break;default:M[h]($)&&(r.types[e]=M[$],x&&!V&&D&&(g=M[$](I)))}for(V||((p=C.attr(i("validate")))||N||w||"email"===b||"url"===b||"datetime"===b||"date"===b||"time"===b)&&(p&&O[h](p=p[T]())?"BETWEEN"===p?(_=[parseInt(C.attr(i("min")),10),parseInt(C.attr(i("max")),10)],isNaN(_[0])||isNaN(_[1])||(r.validators[e]=r.validators[h](e)?r.validators[e].AND(O.BETWEEN(_[0],_[1],!1)):O.BETWEEN(_[0],_[1],!1))):"GREATER_THAN"===p?(_=parseInt(C.attr(i("min")),10),isNaN(_)||(r.validators[e]=r.validators[h](e)?r.validators[e].AND(O.GREATER_THAN(_,!0)):O.GREATER_THAN(_,!0))):"LESS_THAN"===p?(_=parseInt(C.attr(i("max")),10),isNaN(_)||(r.validators[e]=r.validators[h](e)?r.validators[e].AND(O.LESS_THAN(_,!0)):O.LESS_THAN(_,!0))):"DATETIME"===p||"DATE"===p||"TIME"===p?(_=C.attr(i("format"))||"Y-m-d",r.validators[e]=r.validators[h](e)?r.validators[e].AND(O.DATETIME(_,l&&l.datetime?l.datetime:null)):O.DATETIME(_,l&&l.datetime?l.datetime:null)):r.validators[e]=r.validators[h](e)?r.validators[e].AND(O[p]):O[p]:"email"===b?r.validators[e]=r.validators[h](e)?r.validators[e].AND(O.EMAIL):O.EMAIL:"url"===b?r.validators[e]=r.validators[h](e)?r.validators[e].AND(O.URL):O.URL:("datetime"===b||"date"===b||"time"===b)&&(_=C.attr(i("format"))||"Y-m-d",r.validators[e]=r.validators[h](e)?r.validators[e].AND(O.DATETIME(_,l&&l.datetime?l.datetime:null)):O.DATETIME(_,l&&l.datetime?l.datetime:null)),C.attr(i("bind"),y({error:"error",change:"change"}))),N||w?(k=V?O.MIN_ITEMS(parseInt(C.attr(i("leastrequired")),10)||1,n):O.NOT_EMPTY,r.validators[e]=r.validators[h](e)?k.AND(r.validators[e]):k,r.validators[e].REQUIRED=1,N&&C.removeAttr("required"),C.attr(i("bind"))||C.attr(i("bind"),y({error:"error",change:"change"}))):V||"function"!=typeof r.validators[e]||r.validators[e].REQUIRED||(r.validators[e]=O.EMPTY.OR(r.validators[e])),c=e.split("."),v=r.data;c.length;)m=c.shift(),c.length?(v[h](m)||(v[m]=j.test(c[0])?[]:{}),v=v[m]):(v[h](m)||(v[m]=V?[]:g),x?"radio"===b&&C.prop("checked")?v[m]=f:"checkbox"===b&&(R=t(C[0].form).find('input[type="checkbox"][name="'+L+'"]'),v[m]=V?t.map(R.filter(o),s):R.length>1?t.map(R,s):D?C.prop("checked")?f:g:C.prop("checked")?f:g,u[L]=1):v[m]=f)}})}var v,f,g=Object.create,p="prototype",h="hasOwnProperty",T="toUpperCase",E="toLowerCase",$=Object.keys,y=JSON.stringify,b=(JSON.parse,Object[p].toString),N=function(e){return e instanceof Object||"[object Object]"===b.call(e)},A=/\[\s*\]$/,w=/^\s+|\s+$/g,j=/^\d+$/,k=/\[([^\]]*)\]/g,x=/^\.+|\.+$/g,I=String[p].trim?function(e){return e.trim()}:function(e){return e.replace(w,"")},S=r.UUID,M=r.Type.Cast,O=r.Validation.Validate,D=r.Model;v=function(){var e=this;r.View.apply(e,arguments)},v[p]=g(r.View[p]),v[p].do_change=function(e,r){var a=t(r);r.validity.valid||r.setCustomValidity(""),a.hasClass("mvform-error")&&a.removeClass("mvform-error")},v[p].do_error=function(e,r){var a=t(r);r.validity.valid||r.setCustomValidity(""),a.hasClass("mvform-error")||a.addClass("mvform-error")},f=e.ModelViewForm=function R(e){var r=this;return r instanceof R?(r.id=S("mvform"),r.$options=t.extend({submit:!0,notify:!0,model:!1,livebind:!1,prefixed:!1,locale:{},Model:R.Model,View:R.View,ajax:!1},e||{}),void r.initPubSub()):new R(e)},f.VERSION="0.6",f.Model=D,f.View=v,f.doSubmit=function(e,r){return r=r||"json",function(a,i,o){var s=function(e,t){"success"==t?o(!0,e):o(!1,e)};t.ajax({type:e,dataType:r,url:a,data:i||null,success:s,error:s})}},f.doGET=f.doSubmit("GET","json"),f.doPOST=f.doSubmit("POST","json"),f.fields2model=m,f[p]=r.Extend(g(Object[p]),r.PublishSubscribeInterface,{constructor:f,id:null,$form:null,$view:null,$messages:null,$options:null,dispose:function(){var e=this;return e.disposePubSub(),e.$form&&(e.$form.off("submit."+e.id),e.$form.modelview("dispose"),e.$form.removeClass("mvform")),e.$form=null,e.$view=null,e.$messages=null,e.$options=null,e.id=null,e},trigger:function(e,t,a){var i=this,o=r.PublishSubscribeInterface.trigger;return a=a||0,a>0?setTimeout(function(){o.call(i,e,t)},a):o.call(i,e,t),i},one:function(e,t){return this.on(e,t,!0)},dom:function(e){var r=this;return r.$form=t(e),r._render(),r},tpl:function(e,r){var a=this;return a.$form=t(e.innerHTML).appendTo(r),a._render(),a},serialize:function(){var e=this,t={};return t[e.$view.$model.id]=e.$view.$model.serialize(),t},validate:function(){{var e,t=this;t.$form,t.$options||{}}return t.trigger("before-validate"),e=t.$view.$model.validate(),t.trigger("after-validate",e),e},notify:function(e){var t,r,a,o=this,s=o.$form;return s&&s.length&&e&&e.length&&(o.$view.$model.notify(e,"error"),o.$messages&&o.$messages.length&&(t=o.$options.prefixed?o.$view.$model.id+".":"",r=i("error")+'="'+t,a="["+r+e.join('"],['+r)+'"]',o.$messages.hide(),s.find(a).show())),o},_render:function(){var e,t=this,r=t.$options||{},a=r.Model||f.Model,o=r.View||f.View,s=t.$form,n={id:r.model?r.model:(e=s.attr(i("model")))?e:"model",data:{},types:{},validators:{},getters:{},setters:{},dependencies:{}};return s.addClass("mvform").attr("id",s[0].id||S("mvform")),t.trigger("before-render"),t.$messages=s.find("["+i("error")+"]").hide(),m(s.find("input,textarea,select"),n,r.locale),s.modelview({autoSync:!0,autobind:!0,livebind:r.livebind,isomorphic:!1,autovalidate:!1,bindAttribute:i("bind"),events:["change","error","click"],model:n,modelClass:a,viewClass:o}),t.$view=s.modelview("view"),c(s.find("input["+i("ajax-suggest")+"]"),t),u(s.find("select["+i("ajax-options")+"]"),t),r.submit&&s.on("submit."+t.id,function(e){var r,a,i=t.$options;return e.preventDefault(),e.stopPropagation(),t.$messages.hide(),r=t.validate(),r.isValid?i.ajax?(t.trigger("before-send",a=t.serialize()),a&&i.ajax&&f.doPOST(i.ajax,a,function(e,r){t.trigger("after-send",{success:e,response:r})})):t.trigger("submit",t.serialize()):i.notify&&t.notify(r.errors),!1}),t.trigger("after-render"),t}})}(window,jQuery,ModelView);