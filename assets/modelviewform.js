/**
*
*   ModelViewForm.js
*   Declarative MV Form building, rendering, validation 
*   @dependencies: jQuery, DateX, ModelView
*   @version: 0.9.0
*
*   https://github.com/foo123/modelview.js
*   https://github.com/foo123/modelview-form.js
*
**/
!function(e,t,r,a,i,o){"use strict";function s(e){return"data-mvform-"+e}function l(e){return!!e&&e.length}function d(e,t){t=t||[];var r,a,i,o,n,l,d,u="";for((r=e.attr(s("selected-multiple")))?(e.removeAttr(s("selected-multiple")),r=r.split(",")):(r=e.attr(s("selected")))?e.removeAttr(s("selected")):r=e.val(),a=0,i=t.length;i>a;a++)o=t[a],x(o)?(n=o.key,l=o.value):(n=o,l=o),u+='<option value="'+n+'">'+l+"</option>";return d=e.children("optgroup"),d=d.length?d.eq(0):e,d.children("option:not(.default,.placeholder)").remove(),d.append(u),e.val(r),e}function u(e,r){var a=r.$view.$model,i=a.id+".",o=!1,n={};e.each(function(){var e,r,a,l,d=t(this),u=d.attr("name");u&&(e=L(u),i===e.slice(0,i.length)&&(e=e.slice(i.length),l=d.attr(s("ajax-options")),r=d.attr(s("key")),a=d.attr(s("ajax-key")),a||(a=r),a&&r&&l&&(n[r]={key:a,model_key:r,options:l,$el:d},o=!0)))}),o&&(a.on("change",function(e,t){var i,o;t.key&&n[E](t.key)&&(o=n[t.key],i={},i[o.key]=a.get(o.model_key),o.$el.addClass("mvform-progress"),r.trigger("before-ajax-options",o),p.doGET(o.options,i,function(e,t){d(o.$el,t||[]).removeClass("mvform-progress").trigger("change"),r.trigger("after-ajax-options",o)}))}),a.notify(b(n),"change"))}function c(e,t){if("function"==typeof e)return e;if(t){var r=B("^"+P(t)+"([\\.\\[].+)$");return function(t){var a,i=t[y](e);return i&&(a=i.match(r))?a[1]:null}}return function(t){return t[y](e)}}function f(e,r){return"function"==typeof e?e:!1!==r?function(r){var a=("value"===e?t(r).val():r[y](e))||"",i=(r[y]("type")||r.tagName||"").toLowerCase();return("checkbox"!==i&&"radio"!==i||r.checked)&&("select"!==i||a.length&&-1!==r.selectedIndex)&&("text"!==i&&"textarea"!==i||k(a).length)?a:o}:function(r){var a=("value"===e?t(r).val():r[y](e))||"",i=(r[y]("type")||r.tagName).toLowerCase();return"checkbox"!==i&&"radio"!==i||r.checked?a:o}}function v(e,r,a,i,o,d){i=c(i||"name",r.id),o=f(o||"value",!1),d=!0===d;for(var u=0,v=e.length;v>u;u++){var m,p,g,h,b,S,x,M,k,R,D,L,_,P,B,q,z,Y,Q=e[u],W=(t(Q),!1);if(m=i(Q)){if(W=j.test(m),D=(Q[y]("type")||"")[$](),B="radio"===D||"checkbox"===D,z=Q[A]("data-else"),q=z?Q[y]("data-else"):null,p=o(Q),null==p){if(W||"checkbox"!==D||Q.checked||!z)continue;p=null}if(h=C(m),g=h.replace(V,""),x=p||"",M="",L=!!Q[y]("required"),_=!!Q[y](s("required")),Q[A]("id")||Q[y]("id",H(g.split(".").join("_"))),R=Q[y](s("type"))||D)switch(R=R[T]()){case"NUMBER":case"INTEGER":case"INT":r.types[g]=U.INT,x=U.INT(x)||0,M=0,B&&!W&&z&&(M=U.INT(q)||0);break;case"BOOLEAN":case"BOOL":r.types[g]=U.BOOL,x=U.BOOL(x)||!1,M=!x,B&&!W&&z&&(M=U.BOOL(q));break;case"EMAIL":case"URL":case"TEXT":case"STRING":case"STR":r.types[g]=U.STR,x=U.STR(x)||"",M="",B&&!W&&z&&(M=U.STR(q)||"");break;default:U[E](R)&&(r.types[g]=U[R],B&&!W&&z&&(M=U[R](q)))}for(W||((k=Q[y](s("validate")))||L||_||"email"===D||"url"===D||"datetime"===D||"date"===D||"time"===D)&&(k?(k=k[T](),"BETWEEN"===k?(Y=[parseInt(Q[y](s("min")),10),parseInt(Q[y](s("max")),10)],isNaN(Y[0])||isNaN(Y[1])||(r.validators[g]=r.validators[E](g)?r.validators[g].AND(G.BETWEEN(Y[0],Y[1],!1)):G.BETWEEN(Y[0],Y[1],!1))):"GREATER_THAN"===k?(Y=parseInt(Q[y](s("min")),10),isNaN(Y)||(r.validators[g]=r.validators[E](g)?r.validators[g].AND(G.GREATER_THAN(Y,!0)):G.GREATER_THAN(Y,!0))):"LESS_THAN"===k?(Y=parseInt(Q[y](s("max")),10),isNaN(Y)||(r.validators[g]=r.validators[E](g)?r.validators[g].AND(G.LESS_THAN(Y,!0)):G.LESS_THAN(Y,!0))):"DATETIME"===k||"DATE"===k||"TIME"===k?(Y=Q[y](s("format"))||"Y-m-d H:i:s",r.validators[g]=r.validators[E](g)?r.validators[g].AND(G.DATETIME(Y,a&&a.datetime?a.datetime:null)):G.DATETIME(Y,a&&a.datetime?a.datetime:null)):G[E](k)&&(r.validators[g]=r.validators[E](g)?r.validators[g].AND(G[k]):G[k])):"email"===D?r.validators[g]=r.validators[E](g)?r.validators[g].AND(G.EMAIL):G.EMAIL:"url"===D?r.validators[g]=r.validators[E](g)?r.validators[g].AND(G.URL):G.URL:("datetime"===D||"date"===D||"time"===D)&&(Y=Q[y](s("format"))||"Y-m-d H:i:s",r.validators[g]=r.validators[E](g)?r.validators[g].AND(G.DATETIME(Y,a&&a.datetime?a.datetime:null)):G.DATETIME(Y,a&&a.datetime?a.datetime:null)),Q[A](s("bind"))||Q[N](s("bind"),I({error:"error",change:"change"}))),L||_?(P=W?G.MIN_ITEMS(parseInt(Q[y](s("leastrequired")),10)||1,l):G.NOT_EMPTY,r.validators[g]=r.validators[E](g)?P.AND(r.validators[g]):P,r.validators[g].REQUIRED=1,L&&Q[w]("required"),Q[A](s("bind"))||Q[N](s("bind"),I({error:"error",change:"change"}))):W||"function"!=typeof r.validators[g]||r.validators[g].REQUIRED||(r.validators[g]=G.EMPTY.OR(r.validators[g])),h=h.split("."),S=r.data;h.length;)b=h.shift(),h.length?(S[E](b)?!d&&O.test(h[0])&&S[b].length<=(n=parseInt(h[0],10))&&(S[b]=S[b].concat(new Array(n-S[b].length+1))):S[b]=W&&1===h.length?[]:!d&&O.test(h[0])?new Array(parseInt(h[0],10)+1):{},S=S[b]):W?S.push(x):S[b]=W||"checkbox"!==D||Q.checked||!z?x:M}}}var m,p,g=Object.create,h="prototype",E="hasOwnProperty",T="toUpperCase",$="toLowerCase",b=Object.keys,y="getAttribute",N="setAttribute",A="hasAttribute",w="removeAttribute",I=JSON.stringify,S=(JSON.parse,Object[h].toString),x=function(e){return"[object Object]"===S.call(e)},M=/^\s+|\s+$/g,k=String[h].trim?function(e){return e.trim()}:function(e){return e.replace(M,"")},O=/^\d+$/,R=/\[([^\]]*)\]/g,j=/\[\s*\]$/,D=/^\.+/g,V=/^\.+|\.+$/g,L=function(e){return e.replace(R,".$1").replace(V,"")},C=function(e){return e.replace(R,".$1").replace(D,"")},_=/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,P=function(e){return e.replace(_,"\\$&")},B=function(e,t){return new RegExp(e,t||"")},H=a.UUID,U=a.Type.Cast,G=a.Validation.Validate,q=a.Model;G[E]("DATETIME")||(G.DATETIME=function(e,t){if("function"==typeof r){var i=r.getParser(e,t||r.defaultLocale);return a.Validation.Validator(function(e){return!!e&&!1!==i(e)})}return a.Validation.Validator(function(){return!0})}),m=function(){var e=this;a.View.apply(e,arguments)},m[h]=g(a.View[h]),m[h].do_change=function(e,r){var a=t(r);r.validity.valid||r.setCustomValidity(""),a.hasClass("mvform-error")&&a.removeClass("mvform-error")},m[h].do_error=function(e,r){var a=t(r);r.validity.valid||r.setCustomValidity(""),a.hasClass("mvform-error")||a.addClass("mvform-error")},p=e.ModelViewForm=function z(e){var r=this;return r instanceof z?(r.id=H("mvform"),r.$options=t.extend({submit:!0,notify:!0,model:!1,livebind:!1,prefixed:!1,locale:{},Model:z.Model,View:z.View,ajax:!1},e||{}),void r.initPubSub()):new z(e)},p.VERSION="0.9.0",p.Model=q,p.View=m,p.doSubmit=function(e,r){return r=r||"json",function(a,i,o){var n=function(e,t){"success"==t?o(!0,e):o(!1,e)};t.ajax({type:e,dataType:r,url:a,data:i||null,success:n,error:n})}},p.doGET=p.doSubmit("GET","json"),p.doPOST=p.doSubmit("POST","json"),p.getKey=c,p.getValue=f,p.toModel=v,p[h]=a.Extend(g(Object[h]),a.PublishSubscribeInterface,{constructor:p,id:null,$form:null,$view:null,$messages:null,$options:null,dispose:function(){var e=this;return e.disposePubSub(),e.$form&&(e.$form.off("submit."+e.id),e.$form.modelview("dispose"),e.$form.removeClass("mvform")),e.$form=null,e.$view=null,e.$messages=null,e.$options=null,e.id=null,e},trigger:function(e,t,r){var i=this,o=a.PublishSubscribeInterface.trigger;return r=r||0,r>0?setTimeout(function(){o.call(i,e,t)},r):o.call(i,e,t),i},one:function(e,t){return this.on(e,t,!0)},dom:function(e){var r=this;return r.$form=t(e),r._render(),r},tpl:function(e,r){var a=this;return a.$form=t(e.innerHTML).appendTo(r),a._render(),a},serialize:function(){var e=this,t={};return t[e.$view.$model.id]=e.$view.$model.serialize(),t},validate:function(){{var e,t=this;t.$form,t.$options||{}}return t.trigger("before-validate"),e=t.$view.$model.validate(),t.trigger("after-validate",e),e},notify:function(e){var t,r=this,a=r.$form;return a&&a.length&&e&&e.length&&(r.$view.$model.notify(e,"error"),r.$messages&&r.$messages.length&&(r.$messages.hide(),t=s("error")+'="'+(r.$options.prefixed?r.$view.$model.id+".":""),a.find("["+t+e.join('"],['+t)+'"]').show())),r},_render:function(){var e,t=this,r=t.$options||{},a=r.Model||p.Model,i=r.View||p.View,o=t.$form,n={id:r.model?r.model:(e=o.attr(s("model")))?e:"model",data:{},types:{},validators:{},getters:{},setters:{},dependencies:{}};return o.addClass("mvform").attr("id",o[0].id||H("mvform")),t.trigger("before-render"),t.$messages=o.find("["+s("error")+"]").hide(),v(o.find("input,textarea,select"),n,r.locale),o.modelview({autoSync:!0,autobind:!0,livebind:!!r.livebind,isomorphic:!1,autovalidate:!1,bindAttribute:s("bind"),events:["change","error","click"],model:n,modelClass:a,viewClass:i}),t.$view=o.modelview("view"),u(o.find("select["+s("ajax-options")+"]"),t),r.submit&&o.on("submit."+t.id,function(e){var r,a,i=t.$options;return e.preventDefault(),e.stopPropagation(),t.$messages.hide(),r=t.validate(),r.isValid?i.ajax?(t.trigger("before-send",a=t.serialize()),a&&i.ajax&&p.doPOST(i.ajax,a,function(e,r){t.trigger("after-send",{success:e,response:r})})):t.trigger("submit",t.serialize()):i.notify&&t.notify(r.errors),!1}),t.trigger("after-render"),t}})}(window,jQuery,DateX,ModelView,null);