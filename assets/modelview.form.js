/**
*
*   ModelViewForm.js
*   Declarative MV Form building, rendering, localisation, validation 
*   @dependencies: jQuery, ModelView, ModelViewValidation, Xpresion (optional, for custom field expressions)
*   @version: 1.0.0
*
*   https://github.com/foo123/modelview.js
*   https://github.com/foo123/modelview-form.js
*
**/
!function(e,t,r,a,i){"use strict";function o(e){return"data-mvform-"+e}function l(e){return!!e&&e.length}function s(e,t){t=t||[];var r,a,i,n,l,s,d,u="";for((r=e.attr(o("selected-multiple")))?(e.removeAttr(o("selected-multiple")),r=r.split(",")):(r=e.attr(o("selected")))?e.removeAttr(o("selected")):r=e.val(),a=0,i=t.length;i>a;a++)n=t[a],O(n)?(l=n.key,s=n.value):(l=n,s=n),u+='<option value="'+l+'">'+s+"</option>";return d=e.children("optgroup"),d=d.length?d.eq(0):e,d.children("option:not(.default,.placeholder)").remove(),d.append(u),e.val(r),e}function d(e,r){var a=r.$view.$model,i=a.id+".",n=!1,l={};e.each(function(){var e,r,a,s,d=t(this),u=d.attr("name");u&&(e=H(u),i===e.slice(0,i.length)&&(e=e.slice(i.length),s=d.attr(o("ajax-options")),r=d.attr(o("key")),a=d.attr(o("ajax-key")),a||(a=r),a&&r&&s&&(l[r]={key:a,model_key:r,options:s,$el:d},n=!0)))}),n&&(a.on("change",function(e,t){var i,n;t.key&&l[N](t.key)&&(n=l[t.key],i={},i[n.key]=a.get(n.model_key),n.$el.addClass("mvform-progress"),r.trigger("before-ajax-options",n),y.doGET(n.options,i,function(e,t){s(n.$el,t||[]).removeClass("mvform-progress").trigger("change"),r.trigger("after-ajax-options",n)}))}),a.notify(w(l),"change"))}function u(e,t){if("function"==typeof e)return e;if(t){var r=z("^"+q(t)+"([\\.\\[].+)$");return function(t){var a,i=t[L](e);return i&&(a=i.match(r))?a[1]:null}}return function(t){return t[L](e)}}function f(e,r){return"function"==typeof e?e:!1!==r?function(r){var a=r[D]("data-alternative-value")?r[L]("data-alternative-value"):null,n=("value"===e?a&&null!=r[a]?r[a]:t(r).val():r[L](e))||"",o=(r[L]("type")||r.tagName||"").toLowerCase();return"file"===o?a&&null!=r[a]&&r[a].length?r[a]:r.files&&r.files.length?r.files:null:("checkbox"!==o&&"radio"!==o||r.checked)&&("select"!==o||n.length&&-1!==r.selectedIndex)&&("text"!==o&&"textarea"!==o||C(n).length)?n:i}:function(r){var a=r[D]("data-alternative-value")?r[L]("data-alternative-value"):null,n=("value"===e?a&&null!=r[a]?r[a]:t(r).val():r[L](e))||"",o=(r[L]("type")||r.tagName).toLowerCase();return"file"===o?a&&null!=r[a]&&r[a].length?r[a]:r.files&&r.files.length?r.files:null:"checkbox"!==o&&"radio"!==o||r.checked?n:i}}function c(e,r,a,i,s,d){i=u(i||"name",r.id),s=f(s||"value",!1),d=!0===d;for(var c=0,v=e.length;v>c;c++){var m,p,g,h,E,b,y,T,I,w,S,F,O,k,R,C,P,U,H,Y=e[c],q=(t(Y),!1);if(m=i(Y)){if(q=V.test(m),S=(Y[L]("type")||"")[A](),R="radio"===S||"checkbox"===S,C="file"===S,U=Y[D]("data-else"),P=U?Y[L]("data-else"):null,p=s(Y),null==p){if(!C&&(q||"checkbox"!==S||Y.checked||!U))continue;p=null}if(h=G(m),g=h.replace(B,""),y=p||"",T="",F=!!Y[L]("required"),O=!!Y[L](o("required")),Y[D]("id")||Y[L]("id",W(g.split(".").join("_"))),w=Y[L](o("type"))||S)switch(w=w[$]()){case"NUMBER":case"INTEGER":case"INT":r.types[g]=J.INT,y=J.INT(y)||0,T=0,R&&!q&&U&&(T=J.INT(P)||0);break;case"BOOLEAN":case"BOOL":r.types[g]=J.BOOL,y=J.BOOL(y)||!1,T=!y,R&&!q&&U&&(T=J.BOOL(P));break;case"EMAIL":case"URL":case"TEXT":case"STRING":case"STR":r.types[g]=J.STR,y=J.STR(y)||"",T="",R&&!q&&U&&(T=J.STR(P)||"");break;default:J[N](w)&&(r.types[g]=J[w],R&&!q&&U&&(T=J[w](P)))}for(q||((I=Y[L](o("validate")))||F||O||"email"===S||"url"===S||"datetime"===S||"date"===S||"time"===S)&&(I?(I=I[$](),"BETWEEN"===I?(H=[parseInt(Y[L](o("min")),10),parseInt(Y[L](o("max")),10)],isNaN(H[0])||isNaN(H[1])||(r.validators[g]=r.validators[N](g)?r.validators[g].AND(Q.BETWEEN(H[0],H[1],!1)):Q.BETWEEN(H[0],H[1],!1))):"GREATER_THAN"===I?(H=parseInt(Y[L](o("min")),10),isNaN(H)||(r.validators[g]=r.validators[N](g)?r.validators[g].AND(Q.GREATER_THAN(H,!0)):Q.GREATER_THAN(H,!0))):"LESS_THAN"===I?(H=parseInt(Y[L](o("max")),10),isNaN(H)||(r.validators[g]=r.validators[N](g)?r.validators[g].AND(Q.LESS_THAN(H,!0)):Q.LESS_THAN(H,!0))):"DATETIME"===I||"DATE"===I||"TIME"===I?(H=Y[L](o("format"))||"Y-m-d H:i:s",r.validators[g]=r.validators[N](g)?r.validators[g].AND(Q.DATETIME(H,a&&a.datetime?a.datetime:null)):Q.DATETIME(H,a&&a.datetime?a.datetime:null)):"FILESIZE"===I?(H=parseInt(Y[L](o("filesize")),10)||1048576,r.validators[g]=r.validators[N](g)?r.validators[g].AND(Q.FILESIZE(Y,H)):Q.FILESIZE(Y,H)):"FILETYPE"===I||"FILEMIMETYPE"===I?(H=Y[L](o("filetype")),r.validators[g]=r.validators[N](g)?r.validators[g].AND(Q.FILETYPE(Y,H)):Q.FILETYPE(Y,H)):Q[N](I)&&(r.validators[g]=r.validators[N](g)?r.validators[g].AND(Q[I]):Q[I])):"email"===S?r.validators[g]=r.validators[N](g)?r.validators[g].AND(Q.EMAIL):Q.EMAIL:"url"===S?r.validators[g]=r.validators[N](g)?r.validators[g].AND(Q.URL):Q.URL:("datetime"===S||"date"===S||"time"===S)&&(H=Y[L](o("format"))||"Y-m-d H:i:s",r.validators[g]=r.validators[N](g)?r.validators[g].AND(Q.DATETIME(H,a&&a.datetime?a.datetime:null)):Q.DATETIME(H,a&&a.datetime?a.datetime:null)),Y[D](o("bind"))||Y[j](o("bind"),M({error:"error",change:"change"}))),F||O?(k=q?C?Q.MIN_FILES(Y,parseInt(Y[L](o("leastrequired")),10)||1):Q.MIN_ITEMS(parseInt(Y[L](o("leastrequired")),10)||1,l):C?Q.MIN_FILES(Y,1):Q.NOT_EMPTY,r.validators[g]=r.validators[N](g)?k.AND(r.validators[g]):k,r.validators[g].REQUIRED=1,F&&Y[x]("required"),Y[D](o("bind"))||Y[j](o("bind"),M({error:"error",change:"change"}))):q||"function"!=typeof r.validators[g]||r.validators[g].REQUIRED||(r.validators[g]=Q.EMPTY.OR(r.validators[g])),h=h.split("."),b=r.data;h.length;)if(E=h.shift(),h.length){if(b[N](E))!d&&_.test(h[0])&&b[E].length<=(n=parseInt(h[0],10))&&(b[E]=b[E].concat(new Array(n-b[E].length+1)));else if(q&&1===h.length){if(p instanceof FileList){b[E]=y;break}b[E]=[]}else b[E]=!d&&_.test(h[0])?new Array(parseInt(h[0],10)+1):{};b=b[E]}else q?b.push(y):b[E]=q||"checkbox"!==S||Y.checked||!U?y:T}}}function v(e,t,r,a){var i,n,o;if(a)if(k(t))if(V.test(a))for(n=0,o=t.length;o>n;n++)r(e,a,t[n]);else for(n=0,o=t.length;o>n;n++)v(e,t[n],r,a+"["+("object"==typeof t[n]?n:"")+"]");else if(t instanceof FileList)for(n=0,o=t.length;o>n;n++)r(e,a,t[n]);else if(t instanceof File||t instanceof Blob)r(e,a,t);else if(t&&"object"==typeof t)for(i in t)t[N](i)&&v(e,t[i],r,a+"["+i+"]");else r(e,a,t);else if(k(t))for(n=0,o=t.length;o>n;n++)r(e,t[n].name,t[n].value);else if(t instanceof FileList)for(n=0,o=t.length;o>n;n++)r(e,a,t[n]);else if(t instanceof File||t instanceof Blob)r(e,a,t);else if(t&&"object"==typeof t)for(i in t)t[N](i)&&v(e,t[i],r,i);return e}function m(e,t,r){"function"==typeof r&&(r=r()),r instanceof FileList||r instanceof File||r instanceof Blob||e.push(F(t)+"="+F(null==r?"":r))}function p(e,t,r){var a=v(t||[],e||{},m);return!0!==r&&(a=a.join("&").split("%20").join("+")),a}function g(e,t,r){if("function"==typeof r&&(r=r()),r instanceof FileList)for(var a=0,i=r.length;i>a;a++)e.append(t,r[a],r[a].name);else r instanceof File?e.append(t,r,r.name):e.append(t,null==r?"":r)}function h(e,t,r){return null==r&&"undefined"!=typeof FormData&&(r=FormData),r&&e instanceof r?e:v(t||new r,e||{},g)}function E(e){return M(e||{})}var b,y,T=Object.create,I="prototype",N="hasOwnProperty",$="toUpperCase",A="toLowerCase",w=Object.keys,S=Object[I].toString,L="getAttribute",j="setAttribute",D="hasAttribute",x="removeAttribute",M=JSON.stringify,F=(JSON.parse,encodeURIComponent),O=function(e){return"[object Object]"===S.call(e)},k=function(e){return"[object Array]"===S.call(e)},R=/^\s+|\s+$/g,C=String[I].trim?function(e){return e.trim()}:function(e){return e.replace(R,"")},_=/^\d+$/,P=/\[([^\]]*)\]/g,V=/\[\s*\]$/,U=/^\.+/g,B=/^\.+|\.+$/g,H=function(e){return e.replace(P,".$1").replace(B,"")},G=function(e){return e.replace(P,".$1").replace(U,"")},Y=/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,q=function(e){return e.replace(Y,"\\$&")},z=function(e,t){return new RegExp(e,t||"")},J=r.Type.Cast,Q=r.Validation.Validate,W=r.UUID,X=r.Model;b=function(){var e=this;r.View.apply(e,arguments)},b[I]=T(r.View[I]),b[I].do_change=function(e,r){var a=t(r),i=o("proxy"),n=r[D](i)&&r[L](i);r.validity.valid||r.setCustomValidity(""),a.hasClass("mvform-error")&&a.removeClass("mvform-error"),n&&t(n).removeClass("mvform-error")},b[I].do_error=function(e,r){var a=t(r),i=o("proxy"),n=r[D](i)&&r[L](i);r.validity.valid||r.setCustomValidity(""),a.hasClass("mvform-error")||a.addClass("mvform-error"),n&&t(n).addClass("mvform-error")},y=e.ModelViewForm=function Z(e){var r=this;return r instanceof Z?(r.id=W("mvform"),r.$options=t.extend({submit:!0,upload:!1,ajax:!1,notify:!0,model:!1,livebind:!1,prefixed:!1,locale:{},Model:Z.Model,View:Z.View},e||{}),void r.initPubSub()):new Z(e)},y.VERSION="1.0.0",y.Model=X,y.View=b,y.doSubmit=function(r,a,i){return a=a||"json",!0===i?(r="POST",function(i,n,o){var l=function(e,t){"success"==t?o(!0,e):o(!1,e)};!n instanceof e.FormData&&(n=new e.FormData(n));var s={type:r,method:r,dataType:a,url:i,data:n||null,processData:!1,contentType:!1,success:l,error:l};t.ajax(s)}):function(i,n,o){var l=function(e,t){"success"==t?o(!0,e):o(!1,e)},s={type:r,method:r,dataType:a,url:i,data:n||null,success:l,error:l};"undefined"!=typeof e.FormData&&n instanceof e.FormData&&(s.processData=!1,s.contentType=!1),t.ajax(s)}},y.doGET=y.doSubmit("GET","json"),y.doPOST=y.doSubmit("POST","json"),y.doUpload=y.doSubmit("POST","json",!0),y.Attr=o,y.getKey=u,y.getValue=f,y.toModel=c,y.toJSON=E,y.toFormData=h,y.toUrlEncoded=p,y[I]=r.Extend(T(Object[I]),r.PublishSubscribeInterface,{constructor:y,id:null,$form:null,$view:null,$options:null,dispose:function(){var e=this;return e.disposePubSub(),e.$form&&(e.$form.off("submit."+e.id),e.$form.modelview("dispose"),e.$form.removeClass("mvform")),e.$form=null,e.$view=null,e.$options=null,e.id=null,e},trigger:function(e,t,a){var i=this,n=r.PublishSubscribeInterface.trigger;return a=a||0,a>0?setTimeout(function(){n.call(i,e,t)},a):n.call(i,e,t),i},one:function(e,t){return this.on(e,t,!0)},dom:function(e){var r=this;return r.$form=t(e),r._render(),r},tpl:function(e,r){var a=this;return a.$form=t(e.innerHTML).appendTo(r),a._render(),a},serialize:function(){var e=this,t={};return t[e.$view.$model.id]=e.$view.$model.serialize(),t},validate:function(){{var e,t=this;t.$form,t.$options||{}}return t.trigger("before-validate"),e=t.$view.$model.validate(),t.trigger("after-validate",e),e},notify:function(e){var t,r,a=this,i=a.$form,n=o("error");return i&&i.length&&e&&e.length&&(a.$view.$model.notify(e,"error"),t=i.find("["+n+"]"),t.length&&(t.hide(),r=n+'="'+(a.$options.prefixed?a.$view.$model.id+".":""),i.find("["+r+e.join('"],['+r)+'"]').show())),a},_render:function(){var e,t=this,r=t.$options||{},a=r.Model||y.Model,i=r.View||y.View,n=t.$form,l={id:r.model?r.model:(e=n.attr(o("model")))?e:"model",data:{},types:{},validators:{},getters:{},setters:{},dependencies:{}};return n.addClass("mvform").prop("disabled",!1).attr("id",n[0].id||W("mvform")),t.trigger("before-render"),n.find("["+o("error")+"]").hide(),c(n.find("input,textarea,select"),l,r.locale),n.modelview({autoSync:!0,autobind:!0,livebind:!!r.livebind,isomorphic:!1,autovalidate:!1,bindAttribute:o("bind"),events:["change","error","click"],model:l,modelClass:a,viewClass:i}),t.$view=n.modelview("view"),d(n.find("select["+o("ajax-options")+"]"),t),r.submit&&n.on("submit."+t.id,function(e){var r,a,i=t.$options;if(!0!==i.disabled)return e.preventDefault(),e.stopPropagation(),n.find("["+o("error")+"]").hide(),r=t.validate(),r.isValid?i.ajax?(t.trigger("before-send",a=t.serialize()),a&&i.ajax&&(i.upload?y.doUpload(i.ajax,y.toFormData(a),function(e,r){t.trigger("after-send",{success:e,response:r})}):y.doPOST(i.ajax,a,function(e,r){t.trigger("after-send",{success:e,response:r})}))):t.trigger("submit",t.serialize()):i.notify&&t.notify(r.errors),!1}),t.trigger("after-render"),t}})}(window,jQuery,ModelView,"undefined"!=typeof Xpresion?Xpresion:null);