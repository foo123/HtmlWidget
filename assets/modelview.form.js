/**
*
*   ModelViewForm.js
*   Declarative MV Form building, rendering, localisation, validation 
*   @dependencies: jQuery, ModelView, ModelViewValidation, Xpresion (optional, for custom field expressions)
*   @version: 1.0.0
*
*   https://github.com/foo123/modelview.js
*   https://github.com/foo123/modelview-form.js
*
**/
!function(e,t,r,a,i){"use strict";function o(e,r,a,n){var i;!1===n?(i=t.Event(e),null!=a&&(i.data=a),t(r).trigger(i)):document.createEvent?(i=document.createEvent("HTMLEvents"),i.initEvent(e,!0,!0),i.eventName=e,null!=a&&(i.data=a),r.dispatchEvent(i)):(i=document.createEventObject(),i.eventType=e,i.eventName=e,null!=a&&(i.data=a),r.fireEvent("on"+i.eventType,i))}function l(e){return"data-mvform-"+e}function s(e){return!!e&&e.length}function d(e,t){t=t||[];var r,a,n,i,o,s,d,c="";for((r=e.attr(l("selected-multiple")))?(e.removeAttr(l("selected-multiple")),r=r.split(",")):(r=e.attr(l("selected")))?e.removeAttr(l("selected")):r=e.val(),a=0,n=t.length;n>a;a++)i=t[a],R(i)?(o=i.key,s=i.value):(o=i,s=i),c+='<option value="'+o+'">'+s+"</option>";return d=e.children("optgroup"),d=d.length?d.eq(0):e,d.children("option:not(.default,.placeholder)").remove(),d.append(c),e.val(r),e}function c(e,r){var a=r.$view.$model,n=a.id+".",i=!1,s={};e.each(function(){var e,r,a,o,d=t(this),c=d.attr("name");c&&(e=q(c),n===e.slice(0,n.length)&&(e=e.slice(n.length),o=d.attr(l("ajax-options")),r=d.attr(l("key")),a=d.attr(l("ajax-key")),a||(a=r),a&&r&&o&&(s[r]={key:a,model_key:r,options:o,$el:d},i=!0)))}),i&&(a.on("change",function(e,t){var n,i;t.key&&s[$](t.key)&&(i=s[t.key],n={},n[i.key]=a.get(i.model_key),i.$el.addClass("mvform-progress"),r.trigger("before-ajax-options",i),A.doGET(i.options,n,function(e,t){o("change",d(i.$el,t||[]).removeClass("mvform-progress")[0]),r.trigger("after-ajax-options",i)}))}),a.notify(S(s),"change"))}function u(e,t){if("function"==typeof e)return e;if(t){var r=W("^"+Q(t)+"([\\.\\[].+)$");return function(t){var a,n=t[j](e);return n&&(a=n.match(r))?a[1]:null}}return function(t){return t[j](e)}}function f(e,r){return"function"==typeof e?e:!1!==r?function(r){var a=r[D]("data-alt-value")?r[j]("data-alt-value"):null,n=("value"===e?a&&null!=r[a]?r[a]:t(r).val():r[j](e))||"",o=(r[j]("type")||r.tagName||"").toLowerCase();return"file"===o?a&&null!=r[a]&&r[a].length?r[a]:r.files&&r.files.length?r.files:null:("checkbox"!==o&&"radio"!==o||r.checked)&&("select"!==o||n.length&&-1!==r.selectedIndex)&&("text"!==o&&"textarea"!==o||V(n).length)?n:i}:function(r){var a=r[D]("data-alt-value")?r[j]("data-alt-value"):null,n=("value"===e?a&&null!=r[a]?r[a]:t(r).val():r[j](e))||"",o=(r[j]("type")||r.tagName).toLowerCase();return"file"===o?a&&null!=r[a]&&r[a].length?r[a]:r.files&&r.files.length?r.files:null:"checkbox"!==o&&"radio"!==o||r.checked?n:i}}function v(e,r,a,i,o,d){i=u(i||"name",r.id),o=f(o||"value",!1),d=!0===d;for(var c=0,v=e.length;v>c;c++){var m,p,h,g,E,b,y,T,A,I,N,S,L,F,k,R,_,P,V,U=e[c],G=(t(U),!1);if(m=i(U)){if(G=H.test(m),N=(U[j]("type")||"")[C](),k="radio"===N||"checkbox"===N,R="file"===N,P=U[D]("data-else"),_=P?U[j]("data-else"):null,p=o(U),null==p){if(!R&&(G||"checkbox"!==N||U.checked||!P))continue;p=null}if(g=z(m),h=g.replace(Y,""),y=p||"",T="",S=!!U[j]("required"),L=!!U[j](l("required")),U[D]("id")||U[j]("id",K(h.split(".").join("_"))),I=U[j](l("type"))||N)switch(I=I[w]()){case"NUMBER":case"INTEGER":case"INT":r.types[h]=X.INT,y=X.INT(y)||0,T=0,k&&!G&&P&&(T=X.INT(_)||0);break;case"BOOLEAN":case"BOOL":r.types[h]=X.BOOL,y=X.BOOL(y)||!1,T=!y,k&&!G&&P&&(T=X.BOOL(_));break;case"EMAIL":case"URL":case"TEXT":case"STRING":case"STR":r.types[h]=X.STR,y=X.STR(y)||"",T="",k&&!G&&P&&(T=X.STR(_)||"");break;default:X[$](I)&&(r.types[h]=X[I],k&&!G&&P&&(T=X[I](_)))}for(G||((A=U[j](l("validate")))||S||L||"email"===N||"url"===N||"datetime"===N||"date"===N||"time"===N)&&(A?(A=A[w](),"BETWEEN"===A?(V=[parseInt(U[j](l("min")),10),parseInt(U[j](l("max")),10)],isNaN(V[0])||isNaN(V[1])||(r.validators[h]=r.validators[$](h)?r.validators[h].AND(Z.BETWEEN(V[0],V[1],!1)):Z.BETWEEN(V[0],V[1],!1))):"GREATER_THAN"===A?(V=parseInt(U[j](l("min")),10),isNaN(V)||(r.validators[h]=r.validators[$](h)?r.validators[h].AND(Z.GREATER_THAN(V,!0)):Z.GREATER_THAN(V,!0))):"LESS_THAN"===A?(V=parseInt(U[j](l("max")),10),isNaN(V)||(r.validators[h]=r.validators[$](h)?r.validators[h].AND(Z.LESS_THAN(V,!0)):Z.LESS_THAN(V,!0))):"DATETIME"===A||"DATE"===A||"TIME"===A?(V=U[j](l("format"))||"Y-m-d H:i:s",r.validators[h]=r.validators[$](h)?r.validators[h].AND(Z.DATETIME(V,a&&a.datetime?a.datetime:null)):Z.DATETIME(V,a&&a.datetime?a.datetime:null)):"FILESIZE"===A?(V=parseInt(U[j](l("filesize")),10)||1048576,r.validators[h]=r.validators[$](h)?r.validators[h].AND(Z.FILESIZE(V)):Z.FILESIZE(V)):"FILETYPE"===A||"FILEMIMETYPE"===A?(V=U[j](l("filetype")),r.validators[h]=r.validators[$](h)?r.validators[h].AND(Z.FILETYPE(V)):Z.FILETYPE(V)):Z[$](A)&&(r.validators[h]=r.validators[$](h)?r.validators[h].AND(Z[A]):Z[A])):"email"===N?r.validators[h]=r.validators[$](h)?r.validators[h].AND(Z.EMAIL):Z.EMAIL:"url"===N?r.validators[h]=r.validators[$](h)?r.validators[h].AND(Z.URL):Z.URL:("datetime"===N||"date"===N||"time"===N)&&(V=U[j](l("format"))||"Y-m-d H:i:s",r.validators[h]=r.validators[$](h)?r.validators[h].AND(Z.DATETIME(V,a&&a.datetime?a.datetime:null)):Z.DATETIME(V,a&&a.datetime?a.datetime:null)),U[D](l("bind"))||U[x](l("bind"),M({error:"error",change:"change"}))),S||L?(F=G?R?Z.MIN_FILES(parseInt(U[j](l("leastrequired")),10)||1):Z.MIN_ITEMS(parseInt(U[j](l("leastrequired")),10)||1,s):R?Z.MIN_FILES(1):Z.NOT_EMPTY,r.validators[h]=r.validators[$](h)?F.AND(r.validators[h]):F,r.validators[h].REQUIRED=1,S&&U[O]("required"),U[D](l("bind"))||U[x](l("bind"),M({error:"error",change:"change"}))):G||"function"!=typeof r.validators[h]||r.validators[h].REQUIRED||(r.validators[h]=Z.EMPTY.OR(r.validators[h])),g=g.split("."),b=r.data;g.length;)if(E=g.shift(),g.length){if(b[$](E))!d&&B.test(g[0])&&b[E].length<=(n=parseInt(g[0],10))&&(b[E]=b[E].concat(new Array(n-b[E].length+1)));else if(G&&1===g.length){if(p instanceof FileList){b[E]=y;break}b[E]=[]}else b[E]=!d&&B.test(g[0])?new Array(parseInt(g[0],10)+1):{};b=b[E]}else G?b.push(y):b[E]=G||"checkbox"!==N||U.checked||!P?y:T}}}function m(e,t){var r,a,n,i,o,l,s,d;for("data:"===e.substr(0,5)?(-1<(d=e.indexOf(";base64,"))?(n=e.slice(5,d),e=e.slice(d+8),r=F(e)):(n=e.slice(5,d=e.indexOf(",")),e=e.slice(d+1),r=unescape(e)),null==t&&(t=n)):r=e,l=r.length,a=new Uint8Array(l),o=15&l,i=0;o>i;i++)a[i]=255&r.charCodeAt(i);for(i=o;l>i;i+=16)s=i,a[s]=255&r.charCodeAt(s++),a[s]=255&r.charCodeAt(s++),a[s]=255&r.charCodeAt(s++),a[s]=255&r.charCodeAt(s++),a[s]=255&r.charCodeAt(s++),a[s]=255&r.charCodeAt(s++),a[s]=255&r.charCodeAt(s++),a[s]=255&r.charCodeAt(s++),a[s]=255&r.charCodeAt(s++),a[s]=255&r.charCodeAt(s++),a[s]=255&r.charCodeAt(s++),a[s]=255&r.charCodeAt(s++),a[s]=255&r.charCodeAt(s++),a[s]=255&r.charCodeAt(s++),a[s]=255&r.charCodeAt(s++),a[s]=255&r.charCodeAt(s++);return new Blob([a],{type:t})}function p(e,t,r,a){var n,i,o;if(a)if(_(t))if(H.test(a))for(i=0,o=t.length;o>i;i++)r(e,a,t[i]);else for(i=0,o=t.length;o>i;i++)p(e,t[i],r,a+"["+("object"==typeof t[i]?i:"")+"]");else if(t instanceof FileList)for(i=0,o=t.length;o>i;i++)r(e,a,t[i]);else if(t instanceof File||t instanceof Blob)r(e,a,t);else if(t&&"object"==typeof t)for(n in t)t[$](n)&&p(e,t[n],r,a+"["+n+"]");else r(e,a,t);else if(_(t))for(i=0,o=t.length;o>i;i++)r(e,t[i].name,t[i].value);else if(t instanceof FileList)for(i=0,o=t.length;o>i;i++)r(e,a,t[i]);else if(t instanceof File||t instanceof Blob)r(e,a,t);else if(t&&"object"==typeof t)for(n in t)t[$](n)&&p(e,t[n],r,n);return e}function h(e,t,r){"function"==typeof r&&(r=r()),r instanceof FileList||r instanceof File||r instanceof Blob||e.push(k(t)+"="+k(null==r?"":r))}function g(e,t,r){var a=p(t||[],e||{},h);return!0!==r&&(a=a.join("&").split("%20").join("+")),a}function E(e,t,r){if("function"==typeof r&&(r=r()),r instanceof FileList)for(var a=0,n=r.length;n>a;a++)e.append(t,r[a],r[a].name);else r instanceof File?e.append(t,r,r.name):e.append(t,null==r?"":r)}function b(e,t,r){return null==r&&"undefined"!=typeof FormData&&(r=FormData),r&&e instanceof r?e:p(t||new r,e||{},E)}function y(e){return M(e||{})}var T,A,I=Object.create,N="prototype",$="hasOwnProperty",w="toUpperCase",C="toLowerCase",S=Object.keys,L=Object[N].toString,j="getAttribute",x="setAttribute",D="hasAttribute",O="removeAttribute",M=JSON.stringify,F=(JSON.parse,atob),k=encodeURIComponent,R=function(e){return"[object Object]"===L.call(e)},_=function(e){return"[object Array]"===L.call(e)},P=/^\s+|\s+$/g,V=String[N].trim?function(e){return e.trim()}:function(e){return e.replace(P,"")},B=/^\d+$/,U=/\[([^\]]*)\]/g,H=/\[\s*\]$/,G=/^\.+/g,Y=/^\.+|\.+$/g,q=function(e){return e.replace(U,".$1").replace(Y,"")},z=function(e){return e.replace(U,".$1").replace(G,"")},J=/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,Q=function(e){return e.replace(J,"\\$&")},W=function(e,t){return new RegExp(e,t||"")},X=r.Type.Cast,Z=r.Validation.Validate,K=r.UUID,et=r.Model;T=function(){var e=this;r.View.apply(e,arguments)},T[N]=I(r.View[N]),T[N].do_change=function(e,r){var a=t(r),n=l("proxy"),i=r[D](n)&&r[j](n);r.validity.valid||r.setCustomValidity(""),a.hasClass("mvform-error")&&a.removeClass("mvform-error"),i&&t(i).removeClass("mvform-error")},T[N].do_error=function(e,r){var a=t(r),n=l("proxy"),i=r[D](n)&&r[j](n);r.validity.valid||r.setCustomValidity(""),a.hasClass("mvform-error")||a.addClass("mvform-error"),i&&t(i).addClass("mvform-error")},A=e.ModelViewForm=function tt(e){var r=this;return r instanceof tt?(r.id=K("mvform"),r.$options=t.extend({submit:!0,upload:!1,ajax:!1,notify:!0,model:!1,livebind:!1,prefixed:!1,locale:{},Model:tt.Model,View:tt.View},e||{}),void r.initPubSub()):new tt(e)},A.VERSION="1.0.0",A.Model=et,A.View=T,A.doSubmit=function(r,a,n){return a=a||"json",!0===n?(r="POST",function(n,i,o){var l=function(e,t){"success"==t?o(!0,e):o(!1,e)};!i instanceof e.FormData&&(i=new e.FormData(i));var s={type:r,method:r,dataType:a,url:n,data:i||null,processData:!1,contentType:!1,success:l,error:l};t.ajax(s)}):function(n,i,o){var l=function(e,t){"success"==t?o(!0,e):o(!1,e)},s={type:r,method:r,dataType:a,url:n,data:i||null,success:l,error:l};"undefined"!=typeof e.FormData&&i instanceof e.FormData&&(s.processData=!1,s.contentType=!1),t.ajax(s)}},A.doGET=A.doSubmit("GET","json"),A.doPOST=A.doSubmit("POST","json"),A.doUpload=A.doSubmit("POST","json",!0),A.Attr=l,A.getKey=u,A.getValue=f,A.toBlob=m,A.toModel=v,A.toJSON=y,A.toFormData=b,A.toUrlEncoded=g,A[N]=r.Extend(I(Object[N]),r.PublishSubscribeInterface,{constructor:A,id:null,$form:null,$view:null,$options:null,dispose:function(){var e=this;return e.disposePubSub(),e.$form&&(e.$form.off("submit."+e.id),e.$form.modelview("dispose"),e.$form.removeClass("mvform")),e.$form=null,e.$view=null,e.$options=null,e.id=null,e},trigger:function(e,t,a){var n=this,i=r.PublishSubscribeInterface.trigger;return a=a||0,a>0?setTimeout(function(){i.call(n,e,t)},a):i.call(n,e,t),n},one:function(e,t){return this.on(e,t,!0)},dom:function(e){var r=this;return r.$form=t(e),r._render(),r},tpl:function(e,r){var a=this;return a.$form=t(e.innerHTML).appendTo(r),a._render(),a},serialize:function(){var e=this,t={};return t[e.$view.$model.id]=e.$view.$model.serialize(),t},validate:function(){{var e,t=this;t.$form,t.$options||{}}return t.trigger("before-validate"),e=t.$view.$model.validate(),t.trigger("after-validate",e),e},notify:function(e){var t,r,a=this,n=a.$form,i=l("error");return n&&n.length&&e&&e.length&&(a.$view.$model.notify(e,"error"),t=n.find("["+i+"]"),t.length&&(t.hide(),r=i+'="'+(a.$options.prefixed?a.$view.$model.id+".":""),n.find("["+r+e.join('"],['+r)+'"]').show())),a},_render:function(){var e,t=this,r=t.$options||{},a=r.Model||A.Model,n=r.View||A.View,i=t.$form,o={id:r.model?r.model:(e=i.attr(l("model")))?e:"model",data:{},types:{},validators:{},getters:{},setters:{},dependencies:{}};return i.addClass("mvform").prop("disabled",!1).attr("id",i[0].id||K("mvform")),t.trigger("before-render"),i.find("["+l("error")+"]").hide(),v(i.find("input,textarea,select"),o,r.locale),i.modelview({autoSync:!0,autobind:!0,livebind:!!r.livebind,isomorphic:!1,autovalidate:!1,bindAttribute:l("bind"),events:["change","error","click"],model:o,modelClass:a,viewClass:n}),t.$view=i.modelview("view"),c(i.find("select["+l("ajax-options")+"]"),t),r.submit&&i.on("submit."+t.id,function(e){var r,a,n=t.$options;if(!0!==n.disabled)return e.preventDefault(),e.stopPropagation(),i.find("["+l("error")+"]").hide(),r=t.validate(),r.isValid?n.ajax?(t.trigger("before-send",a=t.serialize()),a&&n.ajax&&(n.upload?A.doUpload(n.ajax,A.toFormData(a),function(e,r){t.trigger("after-send",{success:e,response:r})}):A.doPOST(n.ajax,a,function(e,r){t.trigger("after-send",{success:e,response:r})}))):t.trigger("submit",t.serialize()):n.notify&&t.notify(r.errors),!1}),t.trigger("after-render"),t}})}(window,jQuery,ModelView,"undefined"!=typeof Xpresion?Xpresion:null);