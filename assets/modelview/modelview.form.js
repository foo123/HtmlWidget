/**
*
*   ModelViewForm.js
*   Declarative MV Form building, rendering, localisation, validation 
*   @dependencies: jQuery, ModelView, ModelViewValidation, Xpresion (optional, for custom field expressions)
*   @version: 1.0.2
*
*   https://github.com/foo123/modelview.js
*   https://github.com/foo123/modelview-form.js
*
**/
!function(e,t,r,a,i){"use strict";function o(e){return"data-mvform-"+e}function l(e,t){return!!e&&e.length}function s(e,t){t=t||[];var r,a,i,n,l,s,d,c="";for((r=e.attr(o("selected-multiple")))?(e.removeAttr(o("selected-multiple")),r=r.split(",")):(r=e.attr(o("selected")))?e.removeAttr(o("selected")):r=e.val(),a=0,i=t.length;i>a;a++)n=t[a],k(n)?(l=n.key,s=n.value):(l=n,s=n),c+='<option value="'+l+'">'+s+"</option>";return d=e.children("optgroup"),d=d.length?d.eq(0):e,d.children("option:not(.default,.placeholder)").remove(),d.append(c),e.val(r),e}function d(e,r){var a=r.$view.$model,i=a.id+".",n=!1,l={},d=!1;return e.each(function(){var e,r,a,s,d=t(this),c=d.attr("name");c&&(e=Y(c),i===e.slice(0,i.length)&&(e=e.slice(i.length),s=d.attr(o("ajax-options")),r=d.attr(o("key")),a=d.attr(o("ajax-key")),a||(a=r),a&&r&&s&&(l[r]={key:a,model_key:r,options:s,$el:d,_inited:0},n=!0)))}),n?(a.on("change",function(e,t){var i,o;t.key&&l[N](t.key)&&(o=l[t.key],i={},i[o.key]=a.get(o.model_key),o.$el.addClass("mvform-progress"),r.trigger("before-ajax-options",o),T.doGET(o.options,i,function(e,t){if(Z("change",s(o.$el,t||[]).removeClass("mvform-progress")[0]),r.trigger("after-ajax-options",o),!0===d){o._inited=1;var a,i=0,n=0;for(var a in l)l[N](a)&&(n++,l[a]._inited&&i++);n>0&&n===i&&(d=!1,r.trigger("inited"))}}))}),d=!0,a.notify(C(l),"change"),!1):!0}function c(e,t){if("function"==typeof e)return e;if(t){var r=Q("^"+J(t)+"([\\.\\[].+)$");return function(t){var a,i=t[x](e);return i&&(a=i.match(r))?a[1]:null}}return function(t){return t[x](e)}}function u(e,r){return"function"==typeof e?e:!1!==r?function(r){var a=r[L]("data-alt-value")?r[x]("data-alt-value"):null,o=("value"===e?a&&null!=r[a]?r[a]:t(r).val():r[x](e))||"",n=(r[x]("type")||r.tagName||"").toLowerCase();return"file"===n?a&&null!=r[a]&&r[a].length?r[a]:r.files&&r.files.length?r.files:null:("checkbox"!==n&&"radio"!==n||r.checked)&&("select"!==n||o.length&&-1!==r.selectedIndex)&&("text"!==n&&"textarea"!==n||P(o).length)?o:i}:function(r){var a=r[L]("data-alt-value")?r[x]("data-alt-value"):null,o=("value"===e?a&&null!=r[a]?r[a]:t(r).val():r[x](e))||"",n=(r[x]("type")||r.tagName).toLowerCase();return"file"===n?a&&null!=r[a]&&r[a].length?r[a]:r.files&&r.files.length?r.files:null:"checkbox"!==n&&"radio"!==n||r.checked?o:i}}function f(e,r,a,i,s,d){i=c(i||"name",r.id),s=u(s||"value",!1),d=!0===d;for(var f=0,v=e.length;v>f;f++){var m,p,h,g,E,b,y,T,A,I,C,S,M,F,k,R,_,P,U,H=e[f],Y=(t(H),!1);if(m=i(H)){if(Y=B.test(m),C=(H[x]("type")||"")[w](),k="radio"===C||"checkbox"===C,R="file"===C,P=H[L]("data-else"),_=P?H[x]("data-else"):null,p=s(H),null==p){if(!(R||Y||"checkbox"===C&&!H.checked&&P))continue;p=null}if(g=q(m),h=g.replace(G,""),y=p||"",T="",S=!!H[x]("required"),M=!!H[x](o("required")),H[L]("id")||H[x]("id",K(h.split(".").join("_"))),I=H[x](o("type"))||C)switch(I=I[$]()){case"NUMBER":case"INTEGER":case"INT":r.types[h]=W.INT,y=W.INT(y)||0,T=0,k&&!Y&&P&&(T=W.INT(_)||0);break;case"BOOLEAN":case"BOOL":r.types[h]=W.BOOL,y=W.BOOL(y)||!1,T=!y,k&&!Y&&P&&(T=W.BOOL(_));break;case"EMAIL":case"URL":case"TEXT":case"STRING":case"STR":r.types[h]=W.STR,y=W.STR(y)||"",T="",k&&!Y&&P&&(T=W.STR(_)||"");break;default:W[N](I)&&(r.types[h]=W[I],k&&!Y&&P&&(T=W[I](_)))}for(Y||((A=H[x](o("validate")))||S||M||"email"===C||"url"===C||"datetime"===C||"date"===C||"time"===C)&&(A?(A=A[$](),"BETWEEN"===A?(U=[parseInt(H[x](o("min")),10),parseInt(H[x](o("max")),10)],isNaN(U[0])||isNaN(U[1])||(r.validators[h]=r.validators[N](h)?r.validators[h].AND(X.BETWEEN(U[0],U[1],!1)):X.BETWEEN(U[0],U[1],!1))):"GREATER_THAN"===A?(U=parseInt(H[x](o("min")),10),isNaN(U)||(r.validators[h]=r.validators[N](h)?r.validators[h].AND(X.GREATER_THAN(U,!0)):X.GREATER_THAN(U,!0))):"LESS_THAN"===A?(U=parseInt(H[x](o("max")),10),isNaN(U)||(r.validators[h]=r.validators[N](h)?r.validators[h].AND(X.LESS_THAN(U,!0)):X.LESS_THAN(U,!0))):"DATETIME"===A||"DATE"===A||"TIME"===A?(U=H[x](o("format"))||"Y-m-d H:i:s",r.validators[h]=r.validators[N](h)?r.validators[h].AND(X.DATETIME(U,a&&a.datetime?a.datetime:null)):X.DATETIME(U,a&&a.datetime?a.datetime:null)):"FILESIZE"===A?(U=parseInt(H[x](o("filesize")),10)||1048576,r.validators[h]=r.validators[N](h)?r.validators[h].AND(X.FILESIZE(U)):X.FILESIZE(U)):"FILETYPE"===A||"FILEMIMETYPE"===A?(U=H[x](o("filetype")),r.validators[h]=r.validators[N](h)?r.validators[h].AND(X.FILETYPE(U)):X.FILETYPE(U)):X[N](A)&&(r.validators[h]=r.validators[N](h)?r.validators[h].AND(X[A]):X[A])):"email"===C?r.validators[h]=r.validators[N](h)?r.validators[h].AND(X.EMAIL):X.EMAIL:"url"===C?r.validators[h]=r.validators[N](h)?r.validators[h].AND(X.URL):X.URL:"datetime"!==C&&"date"!==C&&"time"!==C||(U=H[x](o("format"))||"Y-m-d H:i:s",r.validators[h]=r.validators[N](h)?r.validators[h].AND(X.DATETIME(U,a&&a.datetime?a.datetime:null)):X.DATETIME(U,a&&a.datetime?a.datetime:null)),H[L](o("bind"))||H[D](o("bind"),O({error:"error",change:"change"}))),S||M?(F=Y?R?X.MIN_FILES(parseInt(H[x](o("leastrequired")),10)||1):X.MIN_ITEMS(parseInt(H[x](o("leastrequired")),10)||1,l):R?X.MIN_FILES(1):X.NOT_EMPTY,r.validators[h]=r.validators[N](h)?F.AND(r.validators[h]):F,r.validators[h].REQUIRED=1,S&&H[j]("required"),H[L](o("bind"))||H[D](o("bind"),O({error:"error",change:"change"}))):Y||"function"!=typeof r.validators[h]||r.validators[h].REQUIRED||(r.validators[h]=X.EMPTY.OR(r.validators[h])),g=g.split("."),b=r.data;g.length;)if(E=g.shift(),g.length){if(b[N](E))!d&&V.test(g[0])&&b[E].length<=(n=parseInt(g[0],10))&&(b[E]=b[E].concat(new Array(n-b[E].length+1)));else if(Y&&1===g.length){if(p instanceof FileList){b[E]=y;break}b[E]=[]}else!d&&V.test(g[0])?b[E]=new Array(parseInt(g[0],10)+1):b[E]={};b=b[E]}else Y?null!=y&&b.push(y):b[E]=Y||"checkbox"!==C||H.checked||!P?y:T}}}function v(e,t){var r,a,i,o,n,l,s,d;for("data:"===e.substr(0,5)?(-1<(d=e.indexOf(";base64,"))?(i=e.slice(5,d),e=e.slice(d+8),r=M(e)):(i=e.slice(5,d=e.indexOf(",")),e=e.slice(d+1),r=unescape(e)),null==t&&(t=i)):r=e,l=r.length,a=new Uint8Array(l),n=15&l,o=0;n>o;o++)a[o]=255&r.charCodeAt(o);for(o=n;l>o;o+=16)s=o,a[s]=255&r.charCodeAt(s++),a[s]=255&r.charCodeAt(s++),a[s]=255&r.charCodeAt(s++),a[s]=255&r.charCodeAt(s++),a[s]=255&r.charCodeAt(s++),a[s]=255&r.charCodeAt(s++),a[s]=255&r.charCodeAt(s++),a[s]=255&r.charCodeAt(s++),a[s]=255&r.charCodeAt(s++),a[s]=255&r.charCodeAt(s++),a[s]=255&r.charCodeAt(s++),a[s]=255&r.charCodeAt(s++),a[s]=255&r.charCodeAt(s++),a[s]=255&r.charCodeAt(s++),a[s]=255&r.charCodeAt(s++),a[s]=255&r.charCodeAt(s++);return new Blob([a],{type:t})}function m(e,t,r,a){var i,o,n;if(a)if(R(t))if(B.test(a))for(o=0,n=t.length;n>o;o++)r(e,a,t[o]);else for(o=0,n=t.length;n>o;o++)m(e,t[o],r,a+"["+("object"==typeof t[o]?o:"")+"]");else if(t instanceof FileList)for(o=0,n=t.length;n>o;o++)r(e,a,t[o]);else if(t instanceof File||t instanceof Blob)r(e,a,t);else if(t&&"object"==typeof t)for(i in t)t[N](i)&&m(e,t[i],r,a+"["+i+"]");else r(e,a,t);else if(R(t))for(o=0,n=t.length;n>o;o++)r(e,t[o].name,t[o].value);else if(t instanceof FileList)for(o=0,n=t.length;n>o;o++)r(e,a,t[o]);else if(t instanceof File||t instanceof Blob)r(e,a,t);else if(t&&"object"==typeof t)for(i in t)t[N](i)&&m(e,t[i],r,i);return e}function p(e,t,r){"function"==typeof r&&(r=r()),r instanceof FileList||r instanceof File||r instanceof Blob||e.push(F(t)+"="+F(null==r?"":r))}function h(e,t,r){var a=m(t||[],e||{},p);return!0!==r&&(a=a.join("&").split("%20").join("+")),a}function g(e,t,r){if("function"==typeof r&&(r=r()),r instanceof FileList)for(var a=0,i=r.length;i>a;a++)e.append(t,r[a],r[a].name);else r instanceof File?e.append(t,r,r.name):e.append(t,null==r?"":r)}function E(e,t,r){return null==r&&"undefined"!=typeof FormData&&(r=FormData),r&&e instanceof r?e:m(t||new r,e||{},g)}function b(e){return O(e||{})}var y,T,A=Object.create,I="prototype",N="hasOwnProperty",$="toUpperCase",w="toLowerCase",C=Object.keys,S=Object[I].toString,x="getAttribute",D="setAttribute",L="hasAttribute",j="removeAttribute",O=JSON.stringify,M=(JSON.parse,atob),F=(btoa,encodeURIComponent),k=(decodeURIComponent,function(e){return"[object Object]"===S.call(e)}),R=function(e){return"[object Array]"===S.call(e)},_=/^\s+|\s+$/g,P=String[I].trim?function(e){return e.trim()}:function(e){return e.replace(_,"")},V=/^\d+$/,U=/\[([^\]]*)\]/g,B=/\[\s*\]$/,H=/^\.+/g,G=/^\.+|\.+$/g,Y=function(e){return e.replace(U,".$1").replace(G,"")},q=function(e){return e.replace(U,".$1").replace(H,"")},z=/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,J=function(e){return e.replace(z,"\\$&")},Q=function(e,t){return new RegExp(e,t||"")},W=r.Type.Cast,X=r.Validation.Validate,Z=r.Event.Dispatch,K=r.UUID,ee=r.Model;y=function(){var e=this;r.View.apply(e,arguments)},y[I]=A(r.View[I]),y[I].do_change=function(e,r){var a=t(r),i=o("proxy"),n=r[L](i)&&r[x](i);r.validity.valid||r.setCustomValidity(""),a.hasClass("mvform-error")&&a.removeClass("mvform-error"),n&&t(n).removeClass("mvform-error")},y[I].do_error=function(e,r){var a=t(r),i=o("proxy"),n=r[L](i)&&r[x](i);r.validity.valid||r.setCustomValidity(""),a.hasClass("mvform-error")||a.addClass("mvform-error"),n&&t(n).addClass("mvform-error")},T=e.ModelViewForm=function te(e){var r=this;return r instanceof te?(r.id=K("mvform"),r.$options=t.extend({submit:!0,upload:!1,ajax:!1,notify:!0,model:!1,livebind:!1,prefixed:!1,locale:{},Model:te.Model,View:te.View},e||{}),void r.initPubSub()):new te(e)},T.VERSION="1.0.2",T.Model=ee,T.View=y,T.doSubmit=function(r,a,i){return a=a||"json",!0===i?(r="POST",function(i,o,n){var l=function(e,t){"success"==t?n(!0,e):n(!1,e)};!o instanceof e.FormData&&(o=new e.FormData(o));var s={type:r,method:r,dataType:a,url:i,data:o||null,processData:!1,contentType:!1,success:l,error:l};t.ajax(s)}):function(i,o,n){var l=function(e,t){"success"==t?n(!0,e):n(!1,e)},s={type:r,method:r,dataType:a,url:i,data:o||null,success:l,error:l};"undefined"!=typeof e.FormData&&o instanceof e.FormData&&(s.processData=!1,s.contentType=!1),t.ajax(s)}},T.doGET=T.doSubmit("GET","json"),T.doPOST=T.doSubmit("POST","json"),T.doUpload=T.doSubmit("POST","json",!0),T.Attr=o,T.getKey=c,T.getValue=u,T.toBlob=v,T.toModel=f,T.toJSON=b,T.toFormData=E,T.toUrlEncoded=h,T[I]=r.Extend(A(Object[I]),r.PublishSubscribeInterface,{constructor:T,id:null,$form:null,$view:null,$options:null,dispose:function(){var e=this;return e.disposePubSub(),e.$form&&(e.$form.off("submit."+e.id),e.$form.modelview("dispose"),e.$form.removeClass("mvform")),e.$form=null,e.$view=null,e.$options=null,e.id=null,e},trigger:function(e,t,a){var i=this,o=r.PublishSubscribeInterface.trigger;return a=a||0,a>0?setTimeout(function(){o.call(i,e,t)},a):o.call(i,e,t),i},one:function(e,t){return this.on(e,t,!0)},dom:function(e){var r=this;return r.$form=t(e),r._render(),r},tpl:function(e,r){var a=this;return a.$form=t(e.innerHTML).appendTo(r),a._render(),a},serialize:function(){var e=this,t={};return t[e.$view.$model.id]=e.$view.$model.serialize(),t},validate:function(){var e,t=this;t.$form,t.$options||{};return t.trigger("before-validate"),e=t.$view.$model.validate(),t.trigger("after-validate",e),e},notify:function(e){var t,r,a=this,i=a.$form,n=o("error");return i&&i.length&&e&&e.length&&(a.$view.$model.notify(e,"error"),t=i.find("["+n+"]"),t.length&&(t.hide(),r=n+'="'+(a.$options.prefixed?a.$view.$model.id+".":""),i.find("["+r+e.join('"],['+r)+'"]').show())),a},_render:function(){var e,t=this,r=t.$options||{},a=r.Model||T.Model,i=r.View||T.View,n=t.$form,l={id:r.model?r.model:(e=n.attr(o("model")))?e:"model",data:{},types:{},validators:{},getters:{},setters:{},dependencies:{}},s=!0;return n.addClass("mvform").prop("disabled",!1).attr("id",n[0].id||K("mvform")),t.trigger("before-render"),n.find("["+o("error")+"]").hide(),f(n.find("input,textarea,select"),l,r.locale),n.modelview({autoSync:!0,autobind:!0,livebind:!!r.livebind,isomorphic:!1,autovalidate:!1,bindAttribute:o("bind"),events:["change","error","click"],model:l,modelClass:a,viewClass:i}),t.$view=n.modelview("view"),r.submit&&n.on("submit."+t.id,function(e){var r,a,i=t.$options;if(!0!==i.disabled)return e.preventDefault(),e.stopPropagation(),n.find("["+o("error")+"]").hide(),r=t.validate(),r.isValid?i.ajax?(t.trigger("before-send",a=t.serialize()),a&&i.ajax&&(i.upload?T.doUpload(i.ajax,T.toFormData(a),function(e,r){t.trigger("after-send",{success:e,response:r})}):T.doPOST(i.ajax,a,function(e,r){t.trigger("after-send",{success:e,response:r})}))):t.trigger("submit",t.serialize()):i.notify&&t.notify(r.errors),!1}),t.trigger("after-render"),s=d(n.find("select["+o("ajax-options")+"]"),t),s&&t.trigger("inited"),t}})}(window,jQuery,ModelView,"undefined"!=typeof Xpresion?Xpresion:null);