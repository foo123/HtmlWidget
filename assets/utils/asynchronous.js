/**
*
*   Asynchronous.js
*   @version: 0.4.8
*
*   Simple JavaScript class to manage asynchronous, parallel, linear, sequential and interleaved tasks
*   https://github.com/foo123/asynchronous.js
*
**/
!function(n,e,r){"use strict";var t;"undefined"!=typeof Components&&"object"==typeof Components.classes&&"object"==typeof Components.classesByID&&Components.utils&&"function"==typeof Components.utils["import"]?(n.EXPORTED_SYMBOLS=[e])&&(n[e]=r.call(n,{XPCOM:n})):"object"==typeof module&&module.exports?module.exports=(module.$deps=module.$deps||{})[e]=module.$deps[e]||r.call(n,{NODE:module})||1:"function"==typeof define&&define.amd&&"function"==typeof require&&"function"==typeof require.specified&&require.specified(e)?define(e,["require","exports","module"],function(){return r.call(n,{AMD:module})}):e in n||(n[e]=t=r.call(n,{}))&&"function"==typeof define&&define.amd&&define(function(){return t})}(this,"Asynchronous",function(exports,undef){"use strict";function formatOptions(n){var e,r=[];if(n)for(e in n)n[HAS](e)&&r.push(e+"="+(!0===n[e]||1===n[e]?"yes":!1===n[e]||0===n[e]?"no":n[e]));return r.join(",")}function runParallelised(n,e){n.$runmode=PARALLELISED,n.$running=!1}function runLinearised(n,e){var r,t=n,o=t.$queue;if(t.$runmode=LINEARISED,o){for(;o.length&&(!o[0]||!o[0].canRun());)o.shift();o.length?(t.$running=!0,r=o.shift(),e?r.runWithArgs(e):r.run(),r.complete()):t.$running=!1}}function runInterleaved(n,e){var r,t=n,o=t.$queue,s=0;if(t.$runmode=INTERLEAVED,o&&o.length){for(t.$running=!0;s<o.length;)r=o[s],r&&r.canRun()?(e?r.runWithArgs(e):r.run(),r.isFinished()?(o.shift(),r.complete()):s++):o.shift();t.$running=!1,t.$timer=SetTime(curry(runInterleaved,t),t.$interval)}}function runSequenced(n,e){var r,t=n,o=t.$queue;t.$runmode=SEQUENCED,o&&o.length&&(r=o[0],r&&r.canRun()?(t.$running=!0,e?r.runWithArgs(e):r.run(),r.isFinished()&&(o.shift(),r.complete())):o.shift(),t.$running=!1,t.$timer=SetTime(curry(runSequenced,t),t.$interval))}var root=this,PROTO="prototype",HAS="hasOwnProperty",Obj=Object,Arr=Array,Func=Function,FP=Func[PROTO],OP=Obj[PROTO],AP=Arr[PROTO],slice=FP.call.bind(AP.slice),toString=OP.toString,is_function=function(n){return"function"==typeof n},is_instance=function(n,e){return n instanceof e},SetTime=setTimeout,ClearTime=clearTimeout,UNDEFINED=undef,UNKNOWN=0,NODE=1,BROWSER=2,DEFAULT_INTERVAL=60,NONE=0,INTERLEAVED=1,LINEARISED=2,PARALLELISED=3,SEQUENCED=4,isXPCOM="undefined"!=typeof Components&&"object"==typeof Components.classes&&"object"==typeof Components.classesByID&&Components.utils&&"function"==typeof Components.utils["import"],isNode="undefined"!=typeof global&&"[object global]"===toString.call(global),isNodeProcess=isNode&&!!process.env.NODE_UNIQUE_ID,isSharedWorker=!isXPCOM&&!isNode&&"undefined"!=typeof SharedWorkerGlobalScope&&"function"==typeof importScripts,isWebWorker=!isXPCOM&&!isNode&&"undefined"!=typeof WorkerGlobalScope&&"function"==typeof importScripts&&navigator instanceof WorkerNavigator,isBrowser=!(isXPCOM||isNode||isWebWorker||isSharedWorker||"undefined"==typeof navigator||"undefined"==typeof document),isBrowserWindow=isBrowser&&!!root.opener,isBrowserFrame=isBrowser&&window.self!==window.top,isAMD="function"==typeof define&&define.amd,supportsMultiThread=isNode||"function"==typeof Worker||"function"==typeof SharedWorker,isThread=isNodeProcess||isSharedWorker||isWebWorker,Thread,numProcessors=isNode?require("os").cpus().length:4,fromJSON=JSON.parse,toJSON=JSON.stringify,onMessage,shared_port,curry=function(n,e){return function(){return n(e)}},URL="undefined"!=typeof root.webkitURL?root.webkitURL:"undefined"!=typeof root.URL?root.URL:null,blobURL=function(n,e){return n&&URL?URL.createObjectURL(new Blob(n.push?n:[n],e||{type:"text/javascript"})):n},path=function n(e){var r;return isNode?{file:__filename,path:__dirname}:isSharedWorker||isWebWorker?{file:r=self.location.href,path:r.split("/").slice(0,-1).join("/")}:isAMD&&e&&e.uri?{file:r=e.uri,path:r.split("/").slice(0,-1).join("/")}:isBrowser&&(r=document.getElementsByTagName("script"))&&r.length?(n.link||(n.link=document.createElement("a")),n.link.href=r[r.length-1].src,r=n.link.href,{file:r,path:r.split("/").slice(0,-1).join("/")}):{path:null,file:null}},thisPath=path(exports.AMD),tpf=thisPath.file,notThisPath=function(n){return!(!n||!n.length||n===tpf)},extend=function(n,e){if(n=n||{},e)for(var r in e)e[HAS](r)&&(n[r]=e[r]);return n},_uuid=0;if(isSharedWorker?(root.close=function(){},root.postMessage=function(n){},onMessage=function e(n){shared_port?(n&&shared_port.addEventListener("message",n),e.handler=null):n&&(e.handler=n)},onconnect=function(n){shared_port=n.ports[0],root.close=function(){shared_port.close()},root.postMessage=function(n){shared_port.postMessage(n)},onMessage.handler&&(shared_port.addEventListener("message",onMessage.handler),onMessage.handler=null),shared_port.start()}):onMessage=isWebWorker?function(n){n&&(onmessage=n)}:isNodeProcess?function(n){n&&process.on("message",function(e){n(fromJSON(e))})}:function(n){},isNode){var fs=require("fs"),ps=require("child_process");root.close=function(){process.exit()},root.postMessage=function(n){process.send(toJSON({data:n}))},root.importScripts=function(scripts){if(scripts&&(scripts=scripts.split(",")).length)for(var i=0,src,ok;i<scripts.length;){ok=!0;try{src=fs.readFileSync(scripts[i++]),eval(src)}catch(e){ok=e}if(!0!==ok)throw ok}},Thread=function(n){var e=this;e.process=ps.fork(n),e.process.on("message",function(n){e.onmessage&&e.onmessage(fromJSON(n))}),e.process.on("error",function(n){e.onerror&&e.onerror(n)})},Thread.Shared=Thread,Thread[PROTO]={constructor:Thread,process:null,onmessage:null,onerror:null,postMessage:function(n){return this.process&&this.process.send(toJSON({data:n})),this},terminate:function(){return this.process&&(this.process.kill(),this.process=null),this}}}else Thread=function(n){var e=this;e.process=new Worker(n),e.process.onmessage=function(n){e.onmessage&&e.onmessage(n)},e.process.onerror=function(n){e.onerror&&e.onerror(n)}},Thread.Shared=Thread,Thread[PROTO]={constructor:Thread,process:null,onmessage:null,onerror:null,postMessage:function(n){return this.process&&this.process.postMessage(n),this},terminate:function(){return this.process&&(this.process.terminate(),this.process=null),this}},"function"==typeof SharedWorker&&(Thread.Shared=function(n){var e=this;e.process=new SharedWorker(n),e.process.port.start(),e.process.port.onmessage=function(n){e.onmessage&&e.onmessage(n)},e.process.port.onerror=e.process.onerror=function(n){e.onerror&&e.onerror(n)}},Thread.Shared[PROTO]={constructor:Thread.Shared,process:null,onmessage:null,onerror:null,postMessage:function(n){return this.process&&this.process.port.postMessage(n),this},terminate:function(){return this.process&&(this.process.port.close(),this.process=null),this}});var BrowserWindow=function r(n){var e=this;return e instanceof r?(e.$id=(++_uuid).toString(16),void(e.options=extend({width:400,height:400,toolbar:0,location:0,directories:0,status:0,menubar:0,scrollbars:1,resizable:1},n))):new r(n)};BrowserWindow[PROTO]={constructor:BrowserWindow,options:null,$id:null,$window:null,dispose:function(){var n=this;return n.$window&&n.close(),n.$window=null,n.$id=null,n.options=null,n},close:function(){var n=this;return n.$window&&(n.$window.closed||n.$window.close(),n.$window=null),n},ready:function(n,e){var r=this,t=function o(){!r.$window||n&&!r.$window[n]?setTimeout(o,50):e()};return setTimeout(t,0),r},open:function(n){var e=this;return!e.$window&&n&&(e.$window=window.open(n.push?blobURL(["\ufeff"].concat(n),{type:"text/html;charset=utf-8"}):n,e.$id,formatOptions(e.options))),e},write:function(n){var e=this;return e.$window&&n&&e.$window.document.write(n),e}};var Task=function t(n){if(n instanceof t)return n;if(!(this instanceof t))return new t(n);var e,r=this,o=null,s=null,i=null,u=!1,a=!1,c=!1,l=!1,p=!1,f=!1,d=null,h=0,m=1,g=null,v=null,$=null,N=undef;r.queue=function(n){return arguments.length?(o=n,r):o},r.jumpNext=function(n){o&&o.jumpNext(!1,n)},r.abort=function(n){o&&(o.abort(!1),n&&(o.dispose(),o=null))},r.dispose=function(){o&&(o.dispose(),o=null)},r.task=function(n){return s=n,r},n&&r.task(n),r.run=e=function(){return s.jumpNext=r.jumpNext,s.abort=r.abort,s.dispose=r.dispose,N=s(),u=!0,s.jumpNext=null,s.abort=null,s.dispose=null,N},r.runWithArgs=function(n){return s.jumpNext=r.jumpNext,s.abort=r.abort,s.dispose=r.dispose,N=s.apply(null,n),u=!0,s.jumpNext=null,s.abort=null,s.dispose=null,N},r.canRun=function(){return s&&(!u||a||c||l||p||f)?(a||c)&&h>=g?!1:c&&!d?!1:!l&&!p||N!==v:!1},r.iif=function(n,e,t){return n?r.task(e):arguments.length>2&&r.task(t),r},r.until=function(n){return N=undef,d=null,v=n,p=!0,f=!1,a=!1,c=!1,l=!1,r.run=e,r},r.untilNot=function(n){return N=undef,d=null,$=n,f=!0,p=!1,a=!1,c=!1,l=!1,r.run=e,r},r.loop=function(n,e,t){return N=undef,d=null,h=e||0,m=t||1,g=n,a=!0,p=!1,f=!1,c=!1,l=!1,r.run=function(){var n;return n=s(h),h+=m,N=n,u=!0,n},r},r.each=function(n){return N=undef,d=n,h=0,m=1,g=n?n.length||0:0,c=!0,p=!1,f=!1,a=!1,l=!1,r.run=function(){var n;return n=s(d[h],h),h++,N=n,u=!0,n},r},r.recurse=function(n,e){return d=null,N=n,v=e,l=!0,p=!1,f=!1,a=!1,c=!1,r.run=function(){var n;return n=s(N),N=n,u=!0,n},r},r.isFinished=function(){var n=!u||f||p||a||c||l;return n&&(p||l)&&N===v&&(n=!1),n&&f&&N!==$&&(n=!1),n&&(a||c)&&h>=g&&(n=!1),!n},r.onComplete=function(n){return i=n||null,r},r.complete=function(){return i&&is_function(i)&&i(),r}},Asynchronous=function o(n,e){if(is_instance(n,Task))return n;if(is_function(n))return new Task(n);if(!is_instance(this,o))return new o(n,e);var r=this;r.$interval=arguments.length?parseInt(n,10)||DEFAULT_INTERVAL:DEFAULT_INTERVAL,r.$timer=null,r.$runmode=NONE,r.$running=!1,r.$queue=[],isThread&&!1!==e&&r.initThread()};if(Asynchronous.VERSION="0.4.8",Asynchronous.Thread=Thread,Asynchronous.Task=Task,Asynchronous.BrowserWindow=BrowserWindow,Asynchronous.MODE={NONE:NONE,INTERLEAVE:INTERLEAVED,LINEAR:LINEARISED,PARALLEL:PARALLELISED,SEQUENCE:SEQUENCED},Asynchronous.Platform={UNDEFINED:UNDEFINED,UNKNOWN:UNKNOWN,NODE:NODE,BROWSER:BROWSER},Asynchronous.supportsMultiThreading=function(){return supportsMultiThread},Asynchronous.isPlatform=function(n){return NODE===n?isNode:BROWSER===n?isBrowser:undef},Asynchronous.isThread=function(n){return NODE===n?isNodeProcess:BROWSER===n?isSharedWorker||isWebWorker:isThread},Asynchronous.path=path,Asynchronous.blob=blobURL,Asynchronous.load=function(n,e,r){if(n){var t=function(){n=n.split(".");for(var e=root;n.length;)n[0]&&n[0].length&&e[n[0]]&&(e=e[n[0]]),n.shift();return e&&root!==e?is_function(e)?!1!==r?new e:e():e:void 0};return e&&e.length&&(e=e.filter(notThisPath),e.length&&importScripts(e.join(","))),t()}return null},Asynchronous.serialize=function(n){n=n||new Asynchronous;var e=function(e){var r=function(){var r=this,t=arguments;n.step(function(){e.apply(r,t)}),n.$running||n.run(LINEARISED)};return r.free=function(){return e},r};return e.free=function(){n&&n.dispose(),n=null},e},Asynchronous[PROTO]={constructor:Asynchronous,$interval:DEFAULT_INTERVAL,$timer:null,$queue:null,$thread:null,$events:null,$runmode:NONE,$running:!1,dispose:function(){var n=this;return n.unfork(!0),n.$timer&&ClearTime(n.$timer),n.$thread=null,n.$timer=null,n.$interval=null,n.$queue=null,n.$runmode=NONE,n.$running=!1,n},empty:function(){var n=this;return n.$timer&&ClearTime(n.$timer),n.$timer=null,n.$queue=[],n.$runmode=NONE,n.$running=!1,n},interval:function(n){return arguments.length?(this.$interval=parseInt(n,10)||this.$interval,this):this.$interval},fork:function(n,e,r,t){var o,s,i,u=this;if(!u.$thread){if(!supportsMultiThread)throw u.$thread=null,new Error("Asynchronous: Multi-Threading is NOT supported!");isNode?(s="Asynchronous: Thread (Process): ",i="Asynchronous: Thread (Process) Error: "):(s="Asynchronous: Thread (Worker): ",i="Asynchronous: Thread (Worker) Error: "),u.$events=u.$events||{},o=u.$thread=!0===t?new Thread.Shared(tpf):new Thread(tpf),o.onmessage=function(n){if(n.data.event){var e=n.data.event,r=n.data.data||null;u.$events&&u.$events[e]?u.$events[e](r):"console.log"!==e&&"console.error"!==e||console.log(s+(r.output||""))}},o.onerror=function(n){if(!u.$events||!u.$events.error)throw new Error(i+n.message+" file: "+n.filename+" line: "+n.lineno);u.$events.error(n)},u.send("initThread",{component:n||null,asInstance:!1!==r,imports:e?[].concat(e):null})}return u},unfork:function(n){var e=this;return e.$thread&&(e.send("dispose"),!0===n&&e.$thread.terminate()),e.$thread=null,e.$events=null,e},initThread:function(){var n=this;return isThread&&(n.$events={},onMessage(function(e){var r=e.data.event,t=e.data.data||null;r&&n.$events[r]?n.$events[r](t):"dispose"===r&&(n.dispose(),close())})),n},listen:function(n,e){return n&&is_function(e)&&this.$events&&(this.$events[n]=e),this},unlisten:function(n,e){return n&&this.$events&&this.$events[n]&&(2>arguments.length||e===this.$events[n])&&delete this.$events[n],this},send:function(n,e){return n&&(isThread?postMessage({event:n,data:e||null}):this.$thread&&this.$thread.postMessage({event:n,data:e||null})),this},task:function(n){return is_instance(n,Task)?n:is_function(n)?Task(n):void 0},iif:function(){var n=arguments,e=new Task;return e.iif.apply(e,n)},until:function(){var n=slice(arguments),e=new Task(n.pop());return e.until.apply(e,n)},untilNot:function(){var n=slice(arguments),e=new Task(n.pop());return e.untilNot.apply(e,n)},loop:function(){var n=slice(arguments),e=new Task(n.pop());return e.loop.apply(e,n)},each:function(){var n=slice(arguments),e=new Task(n.pop());return e.each.apply(e,n)},recurse:function(){var n=slice(arguments),e=new Task(n.pop());return e.recurse.apply(e,n)},step:function(n){var e=this;return n&&e.$queue.push(e.task(n).queue(e)),e},steps:function(){var n,e,r=this,t=arguments;for(e=t.length,n=0;e>n;n++)r.step(t[n]);return r},jumpNext:function(n,e){var r=this,t=r.$queue;return e=e||0,!1!==n?function(){return e<t.length&&(e>0&&t.splice(0,e),r.run(r.$runmode)),r}:(e<t.length&&(e>0&&t.splice(0,e),r.run(r.$runmode)),r)},jumpNextWithArgs:function(n,e,r){var t=this,o=t.$queue;return e=e||0,!1!==n?function(){return e<o.length&&(e>0&&o.splice(0,e),t.run(t.$runmode,arguments)),t}:(e<o.length&&(e>0&&o.splice(0,e),t.run(t.$runmode,r)),t)},abort:function(n,e){var r=this;return!1!==n?function(){return e&&e>0?SetTime(function(){r.empty()},e):r.empty(),r}:(e&&e>0?SetTime(function(){r.empty()},e):r.empty(),r)},run:function(n,e){var r=this;return arguments.length?r.$runmode=n:n=r.$runmode,e=e||null,SEQUENCED===n?runSequenced(r,e):INTERLEAVED===n?runInterleaved(r,e):LINEARISED===n?runLinearised(r,e):PARALLELISED===n&&runParallelised(r,e),r}},isThread){var Component=null;root.console={log:function(n){postMessage({event:"console.log",data:{output:n||""}})},error:function(n){postMessage({event:"console.error",data:{output:n||""}})}},onMessage(function(n){var e=n.data.event,r=n.data.data||null;switch(e){case"initThread":r&&r.component&&(Component&&(is_function(Component.dispose)&&Component.dispose(),Component=null),Component=Asynchronous.load(r.component,r.imports,r.asInstance));break;case"dispose":default:Component&&(is_function(Component.dispose)&&Component.dispose(),Component=null),close()}})}return Asynchronous});