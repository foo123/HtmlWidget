YUI.add("moodle-tinymce_mathslate-mathjaxeditor",function(e,t){M.tinymce_mathslate=M.tinymce_mathslate||{};var n=M&&M.tinymce_mathslate||{},r=window.MathJax,i=!0,s={SELECTED:"mathslate-selected",WORKSPACE:"mathslate-workspace",PREVIEW:"mathslate-preview",HIGHLIGHT:"mathslate-highlight",DRAGNODE:"mathslate-workspace-drag",DRAGGEDNODE:"mathslate-workspace-dragged",HELPBOX:"mathslate-help-box",PANEL:"mathslate-bottom-panel"},o={SELECTED:"."+s.SELECTED,HIGHLIGHT:"."+s.HIGHLIGHT};n.MathJaxEditor=function(t){function y(){f=e.Node.create("<span></span>"),f.setHTML(a.preview().replace(/div/g,"span").replace(/<\/*br>/g,"")),e.one(t).appendChild(f),f.all("span").each(function(t){if(!p.get("node").one("#"+t.getAttribute("id")))return;t.appendChild('<span style="position: relative; opacity: 0"><math display="inline">'+w([e.JSON.parse(a.getItemByID(t.getAttribute("id")))]).replace(/id="[^"]*"/,"")+"</math></span>"),t.setAttribute("style","position: absolute; top: 0; left: 0; margin: 0px; z-index: +1")}),f.all("span").each(function(e){if(!p.get("node").one("#"+e.getAttribute("id")))return;var t=p.get("node").one("#"+e.getAttribute("id")).getDOMNode().getBoundingClientRect(),n=e.getDOMNode().getBoundingClientRect();e.setStyle("top",t.top-n.top),e.setStyle("left",t.left-n.left),e.setStyle("width",t.width),e.setStyle("height",t.height)}),r.Hub.Queue(["Typeset",r.Hub,f.getDOMNode()])}function b(){f&&f.remove(),y(),l=f,h.setHTML('<div class="'+s.PREVIEW+'">'+a.preview("tex")+"</div>"),a.getSelected()&&h.one("#"+a.getSelected())&&(p.get("node").one("#"+a.getSelected()).addClass(s.SELECTED),p.get("node").one("#"+a.getSelected()).setAttribute("mathcolor","green"),p.get("node").one("#"+a.getSelected()).setAttribute("stroke","green"),p.get("node").one("#"+a.getSelected()).setAttribute("fill","green"),h.one("#"+a.getSelected()).addClass(s.SELECTED)),a.forEach(function(n){var r=l.one("#"+n[1].id);if(!r)return;r.setAttribute("title",h.one("#"+n[1].id).getHTML().replace(/<div *[^>]*>|<\/div>|<br>/g,"")),r.handleClick=function(e){var t=l.one("#"+a.getSelected());if(!t){e.stopPropagation(),a.select(this.getAttribute("id")),E();return}if(t===r){if(h.one("#"+r.getAttribute("id")).test("."+s.PREVIEW+" >")){a.select(),E();return}r.removeClass(s.SELECTED),h.one("#"+r.getAttribute("id")).removeClass(s.SELECTED),p.get("node").one("#"+a.getSelected()).removeAttribute("mathcolor"),p.get("node").one("#"+a.getSelected()).removeAttribute("stroke"),p.get("node").one("#"+a.getSelected()).removeAttribute("fill"),a.select();return}if(t.one("#"+this.getAttribute("id")))return;e.stopPropagation(),a.insertSnippet(r.getAttribute("id"),a.removeSnippet(t.getAttribute("id"))),a.select(),E()},r.on("click",function(e){this.handleClick(e)});var u=l.one("#"+a.getSelected());if(!i)return;if((!n[1]||!n[1]["class"]||n[1]["class"]!=="blank")&&(!u||!h.one("#"+a.getSelected()).one("#"+n[1].id))){var f=new e.DD.Drag({node:r,moveOnEnd:!1});f.on("drag:start",function(){p.get("node").one("#"+a.getSelected())&&(h.one("#"+a.getSelected()).removeClass(s.SELECTED),p.get("node").one("#"+a.getSelected()).removeClass(s.SELECTED),p.get("node").one("#"+a.getSelected()).removeAttribute("mathcolor"),p.get("node").one("#"+a.getSelected()).removeAttribute("stroke"),p.get("node").one("#"+a.getSelected()).removeAttribute("fill"),a.select()),this.get("node").addClass(s.DRAGGEDNODE),this.get("node").setAttribute("mathcolor","red"),l.one("#"+n[1].id).setAttribute("mathcolor","red"),l.one("#"+n[1].id).setAttribute("stroke","red"),this.get("dragNode").addClass(s.DRAGNODE),this.get("dragNode").all("> span").pop().setStyle("opacity","1")}),f.on("drag:end",function(){this.get("node").removeClass(s.DRAGGEDNODE),this.get("node").removeAttribute("mathcolor"),this.get("node").removeAttribute("stroke"),this.get("dragNode").all("> span").pop().setStyle("opacity","0"),this.get("dragNode").setStyles({top:0,left:0})})}var c=new e.DD.Drop({node:r});c.on("drop:hit",function(e){var t=e.drag.get("node").get("id");e.drag.get("data")?a.insertSnippet(n[1].id,a.createItem(e.drag.get("data"))):t!==n[1].id&&a.isItem(t)&&!h.one("#"+t).one("#"+n[1].id)&&a.insertSnippet(e.drop.get("node").get("id"),a.removeSnippet(t)),E()}),c.on("drop:enter",function(e){e.stopPropagation(),l.all(t+" "+o.HIGHLIGHT).each(function(e){e.removeClass(s.HIGHLIGHT);var t=e.getAttribute("id");p.get("node").one(t)&&(p.get("node").one(t).removeClass(s.HIGHLIGHT),p.get("node").one(t).removeAttribute("mathcolor"),p.get("node").one(t).removeAttribute("stroke"),p.get("node").one(t).removeAttribute("fill"))}),l.one("#"+n[1].id).addClass(s.HIGHLIGHT),p.get("node").one("#"+n[1].id).addClass(s.HIGHLIGHT),p.get("node").one("#"+n[1].id).setAttribute("mathcolor","yellow"),p.get("node").one("#"+n[1].id).setAttribute("stroke","yellow"),p.get("node").one("#"+n[1].id).setAttribute("fill","yellow")}),c.on("drop:exit",function(e){e.stopPropagation(),this.get("node").removeClass(s.HIGHLIGHT),p.get("node").one("#"+n[1].id).removeClass(s.HIGHLIGHT),p.get("node").one("#"+n[1].id).removeAttribute("mathcolor"),p.get("node").one("#"+n[1].id).removeAttribute("stroke"),p.get("node").one("#"+n[1].id).removeAttribute("fill")})})}function w(e){if(typeof e!="object")return e;var t="";return e.forEach(function(e){var n;if(typeof e!="object")return;t+="<"+e[0];if(e[1]&&typeof e[1]=="object")for(n in e[1])typeof e[1][n]!="object"&&(t+=" "+n+'="'+e[1][n]+'"');t+=">",e[2]&&(t+=w(e[2])),t+="</"+e[0]+">"}),t}function E(){a.rekey();var e=r.Hub.getAllJax(p.get("node").getDOMNode())[0];e?r.Hub.Queue(function(){r.Hub.Queue(["Text",e,"<math>"+w(u)+"</math>"]),r.Hub.Queue(b)}):(p.get("node").setHTML(""),r.Hub.Queue(["addElement",r.HTML,p.get("node").getDOMNode(),"math",{display:"block"},u]),r.Hub.Queue(["Typeset",r.Hub,p.get("node").getDOMNode()]),r.Hub.Queue(b))}var u=[],a=new n.mSlots;a.slots.push(u);var f,l;this.workspace=e.one(t).append('<div id="canvas" class="'+s.WORKSPACE+'"/>');var c=e.one(t).appendChild(e.Node.create("<form></form>")),h=e.one(t).appendChild(e
.Node.create('<div class="'+s.PANEL+'"/>'));h.delegate("click",function(e){l.one("#"+this.getAttribute("id")).handleClick(e)},"div");var p=new e.DD.Drop({node:this.workspace.one("#canvas")});this.canvas=p,this.canvas.get("node").on("click",function(){a.select(),E()});var d=e.Node.create('<button type="button" class="'+s.UNDO+'"'+'" title="'+M.util.get_string("undo","tinymce_mathslate")+'"/>'+"<math><mo>&#x25C1;</mo></math>"+"</button>"),v=e.Node.create('<button type="button" class="'+s.REDO+'"'+'" title="'+M.util.get_string("redo","tinymce_mathslate")+'"/>'+"<math><mo>&#x25B7;</mo></math>"+"</button>"),m=e.Node.create('<button type="button" class="'+s.CLEAR+'"'+'" title="'+M.util.get_string("clear","tinymce_mathslate")+'"/>'+"<math><mi>&#x2718;</mi></math>"+"</button>"),g=e.Node.create('<button type="button" class="'+s.HELP+'" title="'+M.util.get_string("help","tinymce_mathslate")+'">'+"<math><mi>&#xE47C;</mi></math>"+"</button>");c.appendChild(m),c.appendChild(d),c.appendChild(v),c.appendChild(g),v.on("click",function(){a=a.redo(),u=a.slots[0],E()}),d.on("click",function(){a=a.undo(),u=a.slots[0],E()}),m.on("click",function(){e.one(t+" "+o.SELECTED)?a.removeSnippet(e.one(t+" "+o.SELECTED).getAttribute("id")):(u=[],a.next=new n.mSlots,a.next.previous=a,a=a.next,a.slots.push(u)),E()}),g.on("click",function(){h.setHTML('<iframe src="'+n.help+'" style="width: '+h.getStyle("width")+'" class="'+s.HELPBOX+'"/>')}),this.render=E,this.toMathML=w,this.addMath=function(n){if(!n)return;e.one(t+" "+o.SELECTED)?a.insertSnippet(e.one(t+" "+o.SELECTED).getAttribute("id"),a.createItem(n)):a.append(a.createItem(n)),E()},this.clear=function(){e.one(t+" "+o.SELECTED)?a.removeSnippet(e.one(t+" "+o.SELECTED).getAttribute("id")):(u=[],a.next=new n.mSlots,a.next.previous=a,a=a.next,a.slots.push(u)),E()},this.output=function(t){function n(e){if(typeof e!="object")return e;var t=e.slice(0);return t.forEach(function(e,r){if(typeof e!="object")return;if(e[1]&&e[1]["class"]){t[r]="[]";return}e[1]&&e[1].id&&delete e[1].id,e[2]&&(e[2]=n(e[2]))}),t}return t==="MathML"?p.get("node").one("script").getHTML():t==="HTML"?p.get("node").one("span").getHTML():t==="JSON"?e.JSON.stringify(n(u)):a.output(t)},this.getHTML=function(){return p.get("node").one("span").getHTML()},this.redo=function(){a=a.redo(),u=a.slots[0],E()},this.undo=function(){a=a.undo(),u=a.slots[0],E()},this.makeDrops=function(){y()},E()}},"@VERSION@",{requires:["moodle-tinymce_mathslate-snippeteditor","dd-drop"]});
