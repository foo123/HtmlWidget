/* globals chrome: false */
/* globals __dirname: false */
/* globals require: false */
/* globals Buffer: false */
/* globals module: false */

/**
 * Typo is a JavaScript implementation of a spellchecker using hunspell-style 
 * dictionaries.
 */
var Typo;!function(){"use strict";Typo=function(e,t,n,r){function i(e,t){var n=f._readFile(e,null,r.asyncLoad);r.asyncLoad?n.then(function(e){t(e)}):t(n)}function s(e){t=e,n&&a()}function o(e){n=e,t&&a()}function a(){for(f.rules=f._parseAFF(t),f.compoundRuleCodes={},u=0,h=f.compoundRules.length;h>u;u++){var e=f.compoundRules[u];for(c=0,p=e.length;p>c;c++)f.compoundRuleCodes[e[c]]=[]}"ONLYINCOMPOUND"in f.flags&&(f.compoundRuleCodes[f.flags.ONLYINCOMPOUND]=[]),f.dictionaryTable=f._parseDIC(n);for(u in f.compoundRuleCodes)0===f.compoundRuleCodes[u].length&&delete f.compoundRuleCodes[u];for(u=0,h=f.compoundRules.length;h>u;u++){var i=f.compoundRules[u],s="";for(c=0,p=i.length;p>c;c++){var o=i[c];s+=o in f.compoundRuleCodes?"("+f.compoundRuleCodes[o].join("|")+")":o}f.compoundRules[u]=new RegExp(s,"i")}f.loaded=!0,r.asyncLoad&&r.loadedCallback&&r.loadedCallback(f)}r=r||{},this.dictionary=null,this.rules={},this.dictionaryTable={},this.compoundRules=[],this.compoundRuleCodes={},this.replacementTable=[],this.flags=r.flags||{},this.loaded=!1;var l,u,c,h,p,f=this;return e&&(f.dictionary=e,t&&n?a():"undefined"!=typeof window&&"chrome"in window&&"extension"in window.chrome&&"getURL"in window.chrome.extension?(l=r.dictionaryPath?r.dictionaryPath:"typo/dictionaries",t||i(chrome.extension.getURL(l+"/"+e+"/"+e+".aff"),s),n||i(chrome.extension.getURL(l+"/"+e+"/"+e+".dic"),o)):(l=r.dictionaryPath?r.dictionaryPath:"undefined"!=typeof __dirname?__dirname+"/dictionaries":"./dictionaries",t||i(l+"/"+e+"/"+e+".aff",s),n||i(l+"/"+e+"/"+e+".dic",o))),this},Typo.prototype={load:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);return this},_readFile:function(e,t,n){if(t=t||"utf8","undefined"!=typeof XMLHttpRequest){var r,i=new XMLHttpRequest;return i.open("GET",e,n),n&&(r=new Promise(function(e,t){i.onload=function(){200===i.status?e(i.responseText):t(i.statusText)},i.onerror=function(){t(i.statusText)}})),i.overrideMimeType&&i.overrideMimeType("text/plain; charset="+t),i.send(null),n?r:i.responseText}if("undefined"!=typeof require){var s=require("fs");try{if(s.existsSync(e)){var o=s.statSync(e),a=s.openSync(e,"r"),l=new Buffer(o.size);return s.readSync(a,l,0,l.length,null),l.toString(t,0,l.length)}console.log("Path "+e+" does not exist.")}catch(u){return console.log(u),""}}},_parseAFF:function(e){var t,n,r,i,s,o,a,l,u={};e=this._removeAffixComments(e);var c=e.split("\n");for(s=0,a=c.length;a>s;s++){t=c[s];var h=t.split(/\s+/),p=h[0];if("PFX"==p||"SFX"==p){var f=h[1],d=h[2];r=parseInt(h[3],10);var g=[];for(o=s+1,l=s+1+r;l>o;o++){n=c[o],i=n.split(/\s+/);var m=i[2],v=i[3].split("/"),y=v[0];"0"===y&&(y="");var C=this.parseRuleCodes(v[1]),b=i[4],R={};R.add=y,C.length>0&&(R.continuationClasses=C),"."!==b&&(R.match=new RegExp("SFX"===p?b+"$":"^"+b)),"0"!=m&&(R.remove="SFX"===p?new RegExp(m+"$"):m),g.push(R)}u[f]={type:p,combineable:"Y"==d,entries:g},s+=r}else if("COMPOUNDRULE"===p){for(r=parseInt(h[1],10),o=s+1,l=s+1+r;l>o;o++)t=c[o],i=t.split(/\s+/),this.compoundRules.push(i[1]);s+=r}else"REP"===p?(i=t.split(/\s+/),3===i.length&&this.replacementTable.push([i[1],i[2]])):this.flags[p]=h[1]}return u},_removeAffixComments:function(e){return e=e.replace(/#.*$/gm,""),e=e.replace(/^\s\s*/m,"").replace(/\s\s*$/m,""),e=e.replace(/\n{2,}/g,"\n"),e=e.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},_parseDIC:function(e){function t(e,t){e in r&&"object"==typeof r[e]||(r[e]=[]),r[e].push(t)}e=this._removeDicComments(e);for(var n=e.split("\n"),r={},i=1,s=n.length;s>i;i++){var o=n[i],a=o.split("/",2),l=a[0];if(a.length>1){var u=this.parseRuleCodes(a[1]);"NEEDAFFIX"in this.flags&&-1!=u.indexOf(this.flags.NEEDAFFIX)||t(l,u);for(var c=0,h=u.length;h>c;c++){var p=u[c],f=this.rules[p];if(f)for(var d=this._applyRule(l,f),g=0,m=d.length;m>g;g++){var v=d[g];if(t(v,[]),f.combineable)for(var y=c+1;h>y;y++){var C=u[y],b=this.rules[C];if(b&&b.combineable&&f.type!=b.type)for(var R=this._applyRule(v,b),w=0,x=R.length;x>w;w++){var F=R[w];t(F,[])}}}p in this.compoundRuleCodes&&this.compoundRuleCodes[p].push(l)}}else t(l.trim(),[])}return r},_removeDicComments:function(e){return e=e.replace(/^\t.*$/gm,"")},parseRuleCodes:function(e){if(!e)return[];if(!("FLAG"in this.flags))return e.split("");if("long"===this.flags.FLAG){for(var t=[],n=0,r=e.length;r>n;n+=2)t.push(e.substr(n,2));return t}return"num"===this.flags.FLAG?e.split(","):void 0},_applyRule:function(e,t){for(var n=t.entries,r=[],i=0,s=n.length;s>i;i++){var o=n[i];if(!o.match||e.match(o.match)){var a=e;if(o.remove&&(a=a.replace(o.remove,"")),"SFX"===t.type?a+=o.add:a=o.add+a,r.push(a),"continuationClasses"in o)for(var l=0,u=o.continuationClasses.length;u>l;l++){var c=this.rules[o.continuationClasses[l]];c&&(r=r.concat(this._applyRule(a,c)))}}}return r},check:function(e){if(!this.loaded)throw"Dictionary not loaded.";var t=e.replace(/^\s\s*/,"").replace(/\s\s*$/,"");if(this.checkExact(t))return!0;if(t.toUpperCase()===t){var n=t[0]+t.substring(1).toLowerCase();if(this.hasFlag(n,"KEEPCASE"))return!1;if(this.checkExact(n))return!0}var r=t.toLowerCase();if(r!==t){if(this.hasFlag(r,"KEEPCASE"))return!1;if(this.checkExact(r))return!0}return!1},checkExact:function(e){if(!this.loaded)throw"Dictionary not loaded.";var t,n,r=this.dictionaryTable[e];if("undefined"==typeof r){if("COMPOUNDMIN"in this.flags&&e.length>=this.flags.COMPOUNDMIN)for(t=0,n=this.compoundRules.length;n>t;t++)if(e.match(this.compoundRules[t]))return!0;return!1}if("object"==typeof r){for(t=0,n=r.length;n>t;t++)if(!this.hasFlag(e,"ONLYINCOMPOUND",r[t]))return!0;return!1}},hasFlag:function(e,t,n){if(!this.loaded)throw"Dictionary not loaded.";return t in this.flags&&("undefined"==typeof n&&(n=Array.prototype.concat.apply([],this.dictionaryTable[e])),n&&-1!==n.indexOf(this.flags[t]))?!0:!1},alphabet:"",suggest:function(e,t){function n(e){var t,n,r,i,s,o,a=[];for(t=0,i=e.length;i>t;t++){var l=e[t];for(n=0,s=l.length+1;s>n;n++){var c=[l.substring(0,n),l.substring(n)];if(c[1]&&a.push(c[0]+c[1].substring(1)),c[1].length>1&&c[1][1]!==c[1][0]&&a.push(c[0]+c[1][1]+c[1][0]+c[1].substring(2)),c[1])for(r=0,o=u.alphabet.length;o>r;r++)u.alphabet[r]!=c[1].substring(0,1)&&a.push(c[0]+u.alphabet[r]+c[1].substring(1));if(c[1])for(r=0,o=u.alphabet.length;o>r;r++)a.push(c[0]+u.alphabet[r]+c[1])}}return a}function r(e){for(var t=[],n=0,r=e.length;r>n;n++)u.check(e[n])&&t.push(e[n]);return t}function i(e){function i(e,t){return e[1]<t[1]?-1:1}var s,o,a=n([e]),l=n(a),c=r(a.concat(l)),h={};for(s=0,o=c.length;o>s;s++)c[s]in h?h[c[s]]+=1:h[c[s]]=1;var p=[];for(s in h)h.hasOwnProperty(s)&&p.push([s,h[s]]);p.sort(i).reverse();var f=[],d="lowercase";for(e.toUpperCase()===e?d="uppercase":e.substr(0,1).toUpperCase()+e.substr(1).toLowerCase()===e&&(d="capitalized"),s=0,o=Math.min(t,p.length);o>s;s++)"uppercase"===d?p[s][0]=p[s][0].toUpperCase():"capitalized"===d&&(p[s][0]=p[s][0].substr(0,1).toUpperCase()+p[s][0].substr(1)),u.hasFlag(p[s][0],"NOSUGGEST")||f.push(p[s][0]);return f}if(!this.loaded)throw"Dictionary not loaded.";if(t=t||5,this.check(e))return[];for(var s=0,o=this.replacementTable.length;o>s;s++){var a=this.replacementTable[s];if(-1!==e.indexOf(a[0])){var l=e.replace(a[0],a[1]);if(this.check(l))return[l]}}var u=this;return u.alphabet="abcdefghijklmnopqrstuvwxyz",i(e)}}}(),"undefined"!=typeof module&&(module.exports=Typo);