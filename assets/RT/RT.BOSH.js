/**
*  RT
*  unified client-side real-time communication using (xhr) polling / bosh / (web)sockets / webrtc for Node/XPCOM/JS
*  RT BOSH Client
*
*  @version: 1.0.1
*  https://github.com/foo123/RT
*
**/
!function(e,n){"use strict";"undefined"!=typeof Components&&"object"==typeof Components.classes&&"object"==typeof Components.classesByID&&Components.utils&&"function"==typeof Components.utils["import"]?n(e,e.RT):"object"==typeof exports?n(e,require("./RT.js")):n(e,e.RT)&&"function"==typeof define&&define.amd&&define(function(){return e.RT})}(this,function(e,n){"use strict";var t="prototype",$=(Object[t].toString,n.Client),r=$[t],o=n.Util,s=n.XHR,c=$.BOSH=function i(e){var n=this;return n instanceof i?(r.constructor.call(n,e),n.$cfg$.timeout=n.$cfg$.timeout||5e3,n.$send$=null,n.$recv$=null,n.$queue$=[],void(n.$mID$=0)):new i(e)};return $.Impl.bosh=$.Impl["long-poll"]=c,c[t]=Object.create(r),c[t].constructor=c,c[t].$send$=null,c[t].$recv$=null,c[t].$queue$=null,c[t].$mID$=null,c[t].dispose=function(){var e=this;return e.$recv$&&(e.$recv$.abort().dispose(),e.$recv$=null),e.$send$&&(e.$send$.abort().dispose(),e.$send$=null),e.$queue$=null,e.$mID$=null,r.dispose.call(e)},c[t].abort=function(e){var n=this;return n.$recv$&&(n.$recv$.abort().dispose(),n.$recv$=null),n.$send$&&(n.$send$.abort().dispose(),n.$send$=null),r.abort.call(n,!0===e)},c[t].send=function(e){var t=this,$=function r(){var e="urlencoded"===t.$cfg$.contentType,$="xml"===t.$cfg$.contentType,c=t.$cfg$.charset?"charset="+String(t.$cfg$.charset):"charset=utf8",i=$?"text/xml":e?"application/x-www-form-urlencoded":"text/plain",u={Connection:"Keep-Alive","Content-Type":i+"; "+c,"X-RT--BOSH":"1","X-RT--Receive":"1","X-RT--mID":t.$mID$},l=t.$queue$.slice(),p=null,d=null;$?(u["X-RT--Send"]="1",d=l.join("")):e?(u["X-RT--Send"]="x-rt--payload",u["X-RT--Message"]=p=n.UUID("------_rt_msg_","_------"),d="x-rt--payload="+o.Url.encode(l.join(p))):(u["X-RT--Send"]="1",u["X-RT--Message"]=p=n.UUID("------_rt_msg_","_------"),d=l.join(p)),t.$send$=s.create({url:t.$cfg$.endpoint+(-1<t.$cfg$.endpoint.indexOf("?")?"&":"?")+"__nocache__="+(new Date).getTime(),timeout:t.$cfg$.timeout,method:"POST",responseType:"text",headers:u,onError:function(e){t.$send$=null,e===t.$recv$&&(t.$recv$=null),t.emit("error",e.statusText)},onTimeout:function(e){t.$send$=null,e===t.$recv$&&(t.$recv$=null),t.$queue$.length?setTimeout(r,100):t.$recv$||setTimeout(function(){t.$receive$()},100)},onComplete:function(e){var n=e.getResponseHeader("X-RT--Message"),$=e.getResponseHeader("X-RT--mID"),o=e.getResponseHeader("X-RT--Close"),s=e.getResponseHeader("X-RT--Error");if(t.$send$=null,e===t.$recv$&&(t.$recv$=null),s)return t.emit("error",s);if(o)return t.close();if($&&(t.$mID$=$),t.$queue$.splice(0,l.length),n){var c,i,u=(e.responseText||"").split(n);for(c=0,i=u.length;i>c;c++)t.emit("receive",u[c])}else e.responseText&&t.emit("receive",e.responseText);t.$queue$.length?setTimeout(r,100):t.$recv$||setTimeout(function(){t.$receive$()},100)}},d)};return t.$queue$.push(String(e)),t.$send$||setTimeout($,0),t},c[t].$receive$=function(){var e=this;if(!e.$recv$){var n="urlencoded"===e.$cfg$.contentType,t="xml"===e.$cfg$.contentType,$=e.$cfg$.charset?"charset="+String(e.$cfg$.charset):"charset=utf8",r=t?"text/xml":n?"application/x-www-form-urlencoded":"text/plain",o={Connection:"Keep-Alive","Content-Type":r+"; "+$,"X-RT--BOSH":"1","X-RT--Receive":"1","X-RT--mID":e.$mID$};e.$recv$=s.create({url:e.$cfg$.endpoint+(-1<e.$cfg$.endpoint.indexOf("?")?"&":"?")+"__nocache__="+(new Date).getTime(),timeout:e.$cfg$.timeout,method:"POST",responseType:"text",headers:o,onError:function(n){e.$send$?(e.$recv$=e.$send$,e.$send$=null):e.$recv$=null,e.emit("error",n.statusText)},onTimeout:function(n){e.$send$?(e.$recv$=e.$send$,e.$send$=null):e.$recv$=null,e.$recv$||setTimeout(function(){e.$receive$()},100)},onComplete:function(n){var t=n.getResponseHeader("X-RT--Message"),$=n.getResponseHeader("X-RT--mID"),r=n.getResponseHeader("X-RT--Close"),o=n.getResponseHeader("X-RT--Error");if(e.$send$?(e.$recv$=e.$send$,e.$send$=null):e.$recv$=null,o)return e.emit("error",o);if(r)return e.close();if($&&(e.$mID$=$),t){var s,c,i=(n.responseText||"").split(t);for(s=0,c=i.length;c>s;s++)e.emit("receive",i[s])}else n.responseText&&e.emit("receive",n.responseText);e.$recv$||setTimeout(function(){e.$receive$()},100)}},null)}},c[t].listen=function(){var e=this;return setTimeout(function(){e.$receive$()},10),e.open()},n});