/**
*  RT
*  unified client-side real-time communication using (xhr) polling / bosh / (web)sockets for Node/XPCOM/JS
*  RT BOSH Client
*
*  @version: 1.0.0
*  https://github.com/foo123/RT
*
**/
!function(e,n){"use strict";"undefined"!=typeof Components&&"object"==typeof Components.classes&&"object"==typeof Components.classesByID&&Components.utils&&"function"==typeof Components.utils["import"]?n(e.RT):"object"==typeof exports?n(require("./RT.js")):n(e.RT)&&"function"==typeof define&&define.amd&&define(function(){return e.RT})}(this,function(e){"use strict";var n="prototype",t=(Object[n].toString,e.Client[n]),$=e.Util,r=e.XHR;return e.Client.BOSH=function o(e){var n=this;return n instanceof o?(t.constructor.call(n,e),n.$cfg$.timeout=n.$cfg$.timeout||5e3,n.$send$=null,n.$recv$=null,n.$queue$=[],void(n.$mID$=0)):new o(e)},e.Client.Impl.bosh=e.Client.Impl["long-poll"]=e.Client.BOSH,e.Client.BOSH[n]=Object.create(t),e.Client.BOSH[n].constructor=e.Client.BOSH,e.Client.BOSH[n].$send$=null,e.Client.BOSH[n].$recv$=null,e.Client.BOSH[n].$queue$=null,e.Client.BOSH[n].$mID$=null,e.Client.BOSH[n].dispose=function(){var e=this;return e.$recv$&&(e.$recv$.abort().dispose(),e.$recv$=null),e.$send$&&(e.$send$.abort().dispose(),e.$send$=null),e.$queue$=null,e.$mID$=null,t.dispose.call(e)},e.Client.BOSH[n].abort=function(e){var n=this;return n.$recv$&&(n.$recv$.abort().dispose(),n.$recv$=null),n.$send$&&(n.$send$.abort().dispose(),n.$send$=null),t.abort.call(n,!0===e)},e.Client.BOSH[n].send=function(n){var t=this,o=function i(){var n=t.$queue$.slice(),o=e.UUID("------_rt_msg_","_------");t.$send$=r.create({url:t.$cfg$.endpoint+(-1<t.$cfg$.endpoint.indexOf("?")?"&":"?")+"__nocache__="+(new Date).getTime(),timeout:t.$cfg$.timeout,method:"POST",responseType:"text",headers:{Connection:"Keep-Alive","Content-Type":"application/x-www-form-urlencoded; charset=utf8","X-RT--BOSH":"1","X-RT--Receive":"1","X-RT--mID":t.$mID$,"X-RT--Send":"x-rt--payload","X-RT--Message":o},onError:function(e){t.$send$=null,e===t.$recv$&&(t.$recv$=null),t.emit("error",e.statusText)},onTimeout:function(e){t.$send$=null,e===t.$recv$&&(t.$recv$=null),t.$queue$.length?setTimeout(i,100):t.$recv$||setTimeout(function(){t.$receive$()},100)},onComplete:function(e){var $=e.getResponseHeader("X-RT--Message"),r=e.getResponseHeader("X-RT--mID"),o=e.getResponseHeader("X-RT--Close"),s=e.getResponseHeader("X-RT--Error");if(t.$send$=null,e===t.$recv$&&(t.$recv$=null),s)return t.emit("error",s);if(o)return t.close();if(r&&(t.$mID$=r),t.$queue$.splice(0,n.length),$){var l,u,c=(e.responseText||"").split($);for(l=0,u=c.length;u>l;l++)t.emit("receive",c[l])}else e.responseText&&t.emit("receive",e.responseText);t.$queue$.length?setTimeout(i,100):t.$recv$||setTimeout(function(){t.$receive$()},100)}},"x-rt--payload="+$.Url.encode(n.join(o)))};return t.$queue$.push(String(n)),t.$send$||setTimeout(o,0),t},e.Client.BOSH[n].$receive$=function(){var e=this;e.$recv$||(e.$recv$=r.create({url:e.$cfg$.endpoint+(-1<e.$cfg$.endpoint.indexOf("?")?"&":"?")+"__nocache__="+(new Date).getTime(),timeout:e.$cfg$.timeout,method:"POST",responseType:"text",headers:{Connection:"Keep-Alive","Content-Type":"application/x-www-form-urlencoded; charset=utf8","X-RT--BOSH":"1","X-RT--Receive":"1","X-RT--mID":e.$mID$},onError:function(n){e.$send$?(e.$recv$=e.$send$,e.$send$=null):e.$recv$=null,e.emit("error",n.statusText)},onTimeout:function(n){e.$send$?(e.$recv$=e.$send$,e.$send$=null):e.$recv$=null,e.$recv$||setTimeout(function(){e.$receive$()},100)},onComplete:function(n){var t=n.getResponseHeader("X-RT--Message"),$=n.getResponseHeader("X-RT--mID"),r=n.getResponseHeader("X-RT--Close"),o=n.getResponseHeader("X-RT--Error");if(e.$send$?(e.$recv$=e.$send$,e.$send$=null):e.$recv$=null,o)return e.emit("error",o);if(r)return e.close();if($&&(e.$mID$=$),t){var i,s,l=(n.responseText||"").split(t);for(i=0,s=l.length;s>i;i++)e.emit("receive",l[i])}else n.responseText&&e.emit("receive",n.responseText);e.$recv$||setTimeout(function(){e.$receive$()},100)}},null))},e.Client.BOSH[n].listen=function(){var e=this;return setTimeout(function(){e.$receive$()},10),e.open()},e});