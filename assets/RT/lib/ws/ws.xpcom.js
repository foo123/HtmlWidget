/*
    WebSocket implementation as XPCOM component
*/
!function(t){"use strict";var e=Components.classes,n=Components.interfaces,s=Components.utils,a=Components.results;s["import"]("resource://gre/modules/Services.jsm");var r=function(t,s,a){var o=this;o._e={},o.readyState=r.CONNECTING,o._ws=e["@mozilla.org/network/protocol;1?name=wss"].createInstance(n.nsIWebSocketChannel),o._ws.initLoadInfo(null,Services.scriptSecurityManager.getSystemPrincipal(),null,n.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,n.nsIContentPolicy.TYPE_WEBSOCKET),"string"==typeof s&&(s=[s]),s&&(o._ws.protocol=s.join(",")),o._ws.asyncOpen(Services.io.newURI(t,null,null),null,0,o,null)};r.CONNECTING=0,r.OPEN=1,r.CLOSING=2,r.CLOSED=3,r.prototype={constructor:r,CONNECTING:r.CONNECTING,OPEN:r.OPEN,CLOSING:r.CLOSING,CLOSED:r.CLOSED,readyState:0,_ws:null,_e:null,addEventListener:function(t,e){this._e[t]=e},removeEventListener:function(t,e){!this._e[t]||null!=e&&e!==this._e[t]||delete this._e[t]},dispatchEvent:function(t,e){this._e[t]&&this._e[t]({event:t,data:e,target:this})},onStart:function(){var t=this;r.CONNECTING===t.readyState&&(t.readyState=r.OPEN,t.dispatchEvent("open"))},onStop:function(t,e){var n=this;r.CLOSING!==n.readyState&&r.OPEN!==n.readyState||(n.readyState=r.CLOSED,n.dispatchEvent(a.NS_OK===e||n._ws.CLOSE_NORMAL===e?"close":"error",{status:e}))},onServerClose:function(t,e,n){var s=this;r.OPEN===s.readyState&&(s.readyState=r.CLOSED,s.dispatchEvent("close",{status:e,statusTxt:n}))},onMessageAvailable:function(t,e){var n=this;r.OPEN===n.readyState&&n.dispatchEvent("message",e)},onBinaryMessageAvailable:function(t,e){var n=this;r.OPEN===n.readyState&&n.dispatchEvent("message",e)},send:function(t){var e=this;if(r.OPEN===e.readyState){try{e._ws.sendMsg(t)}catch(n){return!1}return!0}return!1},close:function(){var t=this;if(r.CLOSING!==t.readyState&&r.CLOSED!==t.readyState){t.readyState=r.CLOSING;try{t._ws.close(t._ws.CLOSE_NORMAL),t.readyState=r.CLOSED}catch(e){t.readyState=r.CLOSED}}}},t.WebSocket=r,t.EXPORTED_SYMBOLS=["WebSocket"]}(this);