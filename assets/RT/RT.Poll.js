/**
*  RT
*  unified client-side real-time communication using (xhr) polling / bosh / (web)sockets for Node/XPCOM/JS
*  RT Poll Client
*
*  @version: 1.0.0
*  https://github.com/foo123/RT
*
**/
!function(e,t){"use strict";"undefined"!=typeof Components&&"object"==typeof Components.classes&&"object"==typeof Components.classesByID&&Components.utils&&"function"==typeof Components.utils["import"]?t(e.RT):"object"==typeof exports?t(require("./RT.js")):t(e.RT)&&"function"==typeof define&&define.amd&&define(function(){return e.RT})}(this,function(e){"use strict";var t="prototype",l=(Object[t].toString,e.Client[t]),n=e.Util,o=e.XHR;return e.Client.Poll=function r(e){var t=this;return t instanceof r?(l.constructor.call(t,e),t.$cfg$.pollInterval=t.$cfg$.pollInterval||1e3,t.$timer$=null,t.$xhr$=null,t.$mID$=0,void(t.$queue$=[])):new r(e)},e.Client.Impl.poll=e.Client.Impl["short-poll"]=e.Client.Poll,e.Client.Poll[t]=Object.create(l),e.Client.Poll[t].constructor=e.Client.Poll,e.Client.Poll[t].$timer$=null,e.Client.Poll[t].$xhr$=null,e.Client.Poll[t].$queue$=null,e.Client.Poll[t].$mID$=null,e.Client.Poll[t].dispose=function(){var e=this;return e.$timer$&&(clearTimeout(e.$timer$),e.$timer$=null),e.$xhr$&&(e.$xhr$.abort().dispose(),e.$xhr$=null),e.$mID$=null,e.$queue$=null,l.dispose.call(e)},e.Client.Poll[t].abort=function(e){var t=this;return t.$timer$&&(clearTimeout(t.$timer$),t.$timer$=null),t.$xhr$&&(t.$xhr$.abort().dispose(),t.$xhr$=null),l.abort.call(t,!0===e)},e.Client.Poll[t].send=function(e){var t=this;return t.$queue$.push(String(e)),t},e.Client.Poll[t].listen=function(){var t=this,l=function r(){var l={"Content-Type":"application/x-www-form-urlencoded; charset=utf8","X-RT--Poll":"1","X-RT--Receive":"1","X-RT--mID":t.$mID$},i=null,$=null;t.$queue$.length&&(l["X-RT--Send"]="x-rt--payload",l["X-RT--Message"]=i=e.UUID("------_rt_msg_","_------"),$=t.$queue$.slice()),t.$xhr$=o.create({url:t.$cfg$.endpoint+(-1<t.$cfg$.endpoint.indexOf("?")?"&":"?")+"__nocache__="+(new Date).getTime(),method:"POST",responseType:"text",headers:l,onError:function(e){t.$xhr$=null,t.emit("error",e.statusText)},onTimeout:function(e){t.$xhr$=null,t.$timer$=setTimeout(r,t.$cfg$.pollInterval)},onComplete:function(e){var l=e.getResponseHeader("X-RT--Message"),n=e.getResponseHeader("X-RT--mID"),o=e.getResponseHeader("X-RT--Close"),i=e.getResponseHeader("X-RT--Error");if(t.$xhr$=null,i)return t.emit("error",i);if(o)return t.close();if(n&&(t.$mID$=n),$&&t.$queue$.splice(0,$.length),l){var s,u,c=(e.responseText||"").split(l);for(s=0,u=c.length;u>s;s++)t.emit("receive",c[s])}else e.responseText&&t.emit("receive",e.responseText);t.$timer$=setTimeout(r,t.$cfg$.pollInterval)}},$?"x-rt--payload="+n.Url.encode($.join(i)):null)};return t.$timer$=setTimeout(l,10),t.open()},e});