/**
*  RT
*  unified client-side real-time communication using (xhr) polling / bosh / (web)sockets / webrtc for Node/XPCOM/JS
*  RT Poll Client
*
*  @version: 1.0.1
*  https://github.com/foo123/RT
*
**/
!function(e,t){"use strict";"undefined"!=typeof Components&&"object"==typeof Components.classes&&"object"==typeof Components.classesByID&&Components.utils&&"function"==typeof Components.utils["import"]?t(e,e.RT):"object"==typeof exports?t(e,require("./RT.js")):t(e,e.RT)&&"function"==typeof define&&define.amd&&define(function(){return e.RT})}(this,function(e,t){"use strict";var n="prototype",r=(Object[n].toString,t.Client),o=r[n],l=t.Util,$=t.XHR,i=r.Poll=function s(e){var t=this;return t instanceof s?(o.constructor.call(t,e),t.$cfg$.pollInterval=t.$cfg$.pollInterval||1e3,t.$timer$=null,t.$xhr$=null,t.$mID$=0,void(t.$queue$=[])):new s(e)};return r.Impl.poll=r.Impl["short-poll"]=i,i[n]=Object.create(o),i[n].constructor=i,i[n].$timer$=null,i[n].$xhr$=null,i[n].$queue$=null,i[n].$mID$=null,i[n].dispose=function(){var e=this;return e.$timer$&&(clearTimeout(e.$timer$),e.$timer$=null),e.$xhr$&&(e.$xhr$.abort().dispose(),e.$xhr$=null),e.$mID$=null,e.$queue$=null,o.dispose.call(e)},i[n].abort=function(e){var t=this;return t.$timer$&&(clearTimeout(t.$timer$),t.$timer$=null),t.$xhr$&&(t.$xhr$.abort().dispose(),t.$xhr$=null),o.abort.call(t,!0===e)},i[n].send=function(e){var t=this;return t.$queue$.push(String(e)),t},i[n].listen=function(){var e=this,n=function r(){var n="urlencoded"===e.$cfg$.contentType,o="xml"===e.$cfg$.contentType,i=e.$cfg$.charset?"charset="+String(e.$cfg$.charset):"charset=utf8",s=o?"text/xml":n?"application/x-www-form-urlencoded":"text/plain",u={"Content-Type":s+"; "+i,"X-RT--Poll":"1","X-RT--Receive":"1","X-RT--mID":e.$mID$},c=null,p=null,a=null;e.$queue$.length&&(p=e.$queue$.slice(),o?(u["X-RT--Send"]="1",a=p.join("")):n?(u["X-RT--Send"]="x-rt--payload",u["X-RT--Message"]=c=t.UUID("------_rt_msg_","_------"),a="x-rt--payload="+l.Url.encode(p.join(c))):(u["X-RT--Send"]="1",u["X-RT--Message"]=c=t.UUID("------_rt_msg_","_------"),a=p.join(c))),e.$xhr$=$.create({url:e.$cfg$.endpoint+(-1<e.$cfg$.endpoint.indexOf("?")?"&":"?")+"__nocache__="+(new Date).getTime(),method:"POST",responseType:"text",headers:u,onError:function(t){e.$xhr$=null,e.emit("error",t.statusText)},onTimeout:function(t){e.$xhr$=null,e.$timer$=setTimeout(r,e.$cfg$.pollInterval)},onComplete:function(t){var n=t.getResponseHeader("X-RT--Message"),o=t.getResponseHeader("X-RT--mID"),l=t.getResponseHeader("X-RT--Close"),$=t.getResponseHeader("X-RT--Error");if(e.$xhr$=null,$)return e.emit("error",$);if(l)return e.close();if(o&&(e.$mID$=o),p&&e.$queue$.splice(0,p.length),n){var i,s,u=(t.responseText||"").split(n);for(i=0,s=u.length;s>i;i++)e.emit("receive",u[i])}else t.responseText&&e.emit("receive",t.responseText);e.$timer$=setTimeout(r,e.$cfg$.pollInterval)}},a)};return e.$timer$=setTimeout(n,10),e.open()},t});