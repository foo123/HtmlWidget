/**
*  RT
*  unified client-side real-time communication using (xhr) polling / bosh / (web)sockets / webrtc for Node/XPCOM/JS
*
*  @version: 1.0.1
*  https://github.com/foo123/RT
*
**/
!function(e,t,n){"use strict";"undefined"!=typeof Components&&"object"==typeof Components.classes&&"object"==typeof Components.classesByID&&Components.utils&&"function"==typeof Components.utils["import"]?(e.EXPORTED_SYMBOLS=[t])&&(e[t]=n(e)):"object"==typeof exports?module.exports=n(e):(e[t]=n(e))&&"function"==typeof define&&define.amd&&define(function(){return e[t]})}(this,"RT",function(e){"use strict";function t(e){e=e||{};var n=(e.use||e.rt_type||"default").toLowerCase();return t.Client.Impl[s](n)?new t.Client.Impl[n](e):new t.Client(e)}var n,r,o="prototype",s="hasOwnProperty",a=Object.keys,i=Object[o].toString,u="undefined"!=typeof Components&&"object"==typeof Components.classes&&"object"==typeof Components.classesByID&&Components.utils&&"function"==typeof Components.utils["import"],l="undefined"!=typeof global&&"[object global]"===i.call(global),c=!u&&!l&&"undefined"!=typeof WorkerGlobalScope&&"function"==typeof importScripts&&navigator instanceof WorkerNavigator,d=!u&&!l&&!c&&"undefined"!=typeof navigator,p=String.fromCharCode,f=/^\s+|\s+$/g,h=String[o].trim?function(e){return e.trim()}:function(e){return e.replace(f,"")},g=/[^A-Za-z0-9\+\/\=]/g,C=/\x0d\x0a/g,E=0;return t.VERSION="1.0.1",t.Platform={XPCOM:u,Node:l,WebWorker:c,Browser:d},n=t.XHR=function m(e,t){var n=this,r=!1;n.readyState=m.UNSENT,n.status=null,n.statusText=null,n.responseType="text",n.responseURL=null,n.response=null,n.responseText=null,n.responseXml=null,n._rawHeaders=null,n._headers=null,n.send=function(t){return r||m.UNSENT!==n.readyState?n:(e&&e(t),n.readyState=m.OPENED,n)},n.abort=function(){return r?n:(r=!0,t&&t(),n)},n.getAllResponseHeaders=function(e){return m.DONE!==n.readyState?null:!0===e?n._headers:n._rawHeaders},n.getResponseHeader=function(e,t){if(null==e||m.DONE!==n.readyState)return null;var r=n._headers||{};return!1!==t&&(e=e.toLowerCase()),r[s](e)?r[e]:null},n.dispose=function(){return n.readyState=null,n.status=null,n.statusText=null,n.responseType=null,n.responseURL=null,n.response=null,n.responseText=null,n.responseXml=null,n._rawHeaders=null,n._headers=null,n.getAllResponseHeaders=null,n.getResponseHeader=null,n.send=null,n.abort=null,n}},n.UNSENT=0,n.OPENED=1,n.HEADERS_RECEIVED=2,n.LOADING=3,n.DONE=4,n.create=u?function(e,o){if(e=e||{},!e.url)return null;var s=Components.classes["@mozilla.org/xmlextras/xmlhttprequest;1"].createInstance(),a=new n(function(e){s.send(e)},function(){s.abort()}),i=function(e,t){return e.readyState=t.readyState,e.responseType=t.responseType,e.responseURL=t.responseURL,e.response=t.response,e.responseText=t.responseText,e.responseXml=t.responseXml,e.status=t.status,e.statusText=t.statusText,e};return a.getAllResponseHeaders=function(e){var t=s.getAllResponseHeaders();return!0===e?r.Header.decode(t):t},a.getResponseHeader=function(e){return s.getResponseHeader(e)},s.open(e.method||"GET",e.url,!e.sync),a.responseType=s.responseType=e.responseType||"text",s.timeout=e.timeout||3e4,e.onProgress&&s.addEventListener("progress",function(){e.onProgress(i(a,s))}),e.onLoadStart&&s.addEventListener("loadstart",function(){e.onLoadStart(i(a,s))}),!e.sync&&e.onStateChange&&s.addEventListener("readystatechange",function(){e.onStateChange(i(a,s))}),s.addEventListener("load",function(){i(a,s),t.XHR.DONE===s.readyState&&(200===s.status?e.onComplete&&e.onComplete(a):e.onRequestError?e.onRequestError(a):e.onError&&e.onError(a))}),s.addEventListener("abort",function(){e.onAbort&&e.onAbort(i(a,s))}),s.addEventListener("error",function(){e.onError&&e.onError(i(a,s))}),s.addEventListener("timeout",function(){e.onTimeout&&e.onTimeout(i(a,s))}),e.headers&&r.Header.encode(e.headers,s),e.mimeType&&s.overrideMimeType(e.mimeType),arguments.length>1&&a.send(o),a}:l?function(e,o){if(e=e||{},!e.url)return null;var s,a,u="[object Object]"===i.call(e.url)?e.url:require("url").parse(e.url),l={method:e.method||"GET",agent:!1,protocol:u.protocol,host:u.hostname,hostname:u.hostname,port:u.port||80,path:(u.pathname||"/")+(u.query?"?"+u.query:"")};return a=new n(function(e){null!=e&&(e=String(e),s.setHeader("Content-Length",String(e.length)),s.write(e)),s.end()},function(){s.abort()}),s=("https:"===l.protocol?require("https").request:require("http").request)(l,function(n){var r="",o=0;a.readyState=t.XHR.OPENED,e.onStateChange&&e.onStateChange(a),a.readyState=t.XHR.HEADERS_RECEIVED,a._rawHeaders=n.rawHeaders.join("\r\n"),a._headers=n.headers,a.responseURL=n.url||null,a.status=n.statusCode||null,a.statusText=n.statusMessage||null,e.onStateChange&&e.onStateChange(a),n.on("data",function(n){r+=n.toString(),o||(o=1,a.readyState=t.XHR.LOADING,e.onStateChange&&e.onStateChange(a),e.onLoadStart&&e.onLoadStart(a)),e.onProgress&&e.onProgress(a)}),n.on("end",function(){a.readyState=t.XHR.DONE,a.responseType="text",a.response=a.responseText=r,e.onStateChange&&e.onStateChange(a),e.onLoadEnd&&e.onLoadEnd(a),t.XHR.DONE===a.readyState&&(200===a.status?e.onComplete&&e.onComplete(a):e.onRequestError?e.onRequestError(a):e.onError&&e.onError(a))}),n.on("error",function(t){a.statusText=t.toString(),e.onError&&e.onError(a)})}),s.setTimeout(e.timeout||3e4,function(t){e.onTimeout&&e.onTimeout(a)}),s.on("abort",function(t){e.onAbort&&e.onAbort(a)}),s.on("error",function(t){a.statusText=t.toString(),e.onError&&e.onError(a)}),e.headers&&r.Header.encode(e.headers,null,s),arguments.length>1&&a.send(o),a}:function(e,o){if(e=e||{},!e.url)return null;var s="undefined"!=typeof XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),a=new n(function(e){s.send(e)},function(){s.abort()}),i=function(e,t){return e.readyState=t.readyState,e.responseType=t.responseType,e.responseURL=t.responseURL,e.response=t.response,e.responseText=t.responseText,e.responseXml=t.responseXml,e.status=t.status,e.statusText=t.statusText,e};return a.getAllResponseHeaders=function(e){var t=s.getAllResponseHeaders();return!0===e?r.Header.decode(t):t},a.getResponseHeader=function(e){return s.getResponseHeader(e)},s.open(e.method||"GET",e.url,!e.sync),a.responseType=s.responseType=e.responseType||"text",s.timeout=e.timeout||3e4,e.onProgress&&(s.onprogress=function(){e.onProgress(i(a,s))}),e.onLoadStart&&(s.onloadstart=function(){e.onLoadStart(i(a,s))}),e.onLoadEnd&&(s.onloadend=function(){e.onLoadEnd(i(a,s))}),!e.sync&&e.onStateChange&&(s.onreadystatechange=function(){e.onStateChange(i(a,s))}),s.onload=function(){i(a,s),t.XHR.DONE===s.readyState&&(200===s.status?e.onComplete&&e.onComplete(a):e.onRequestError?e.onRequestError(a):e.onError&&e.onError(a))},s.onabort=function(){e.onAbort&&e.onAbort(i(a,s))},s.onerror=function(){e.onError&&e.onError(i(a,s))},s.ontimeout=function(){e.onTimeout&&e.onTimeout(i(a,s))},e.headers&&r.Header.encode(e.headers,s),e.mimeType&&s.overrideMimeType(e.mimeType),arguments.length>1&&a.send(o),a},t.UUID=function(e,t){return(e||"")+ ++E+"_"+Date.now()+"_"+Math.floor(1e3*Math.random())+(t||"")},t.Const={BASE64:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",CRLF:"\r\n",CRLF_RE:/(\r\n)|\r|\n/g,COOKIE_RE:/([^=]+)(?:=(.*))?/},r=t.Util={String:{trim:h},Utf8:{encode:function(e){e=e.replace(C,"\n");var t,n,r,o="";for(t=0,n=e.length;n>t;t++)r=e.charCodeAt(t),o+=128>r?p(r):r>127&&2048>r?p(r>>6|192)+p(63&r|128):p(r>>12|224)+p(r>>6&63|128)+p(63&r|128);return o},decode:function(e){for(var t="",n=0,r=c1=c2=0,o=e.length;o>n;)r=e.charCodeAt(n),128>r?(t+=p(r),n++):r>191&&224>r?(c2=e.charCodeAt(n+1),t+=p((31&r)<<6|63&c2),n+=2):(c2=e.charCodeAt(n+1),c3=e.charCodeAt(n+2),t+=p((15&r)<<12|(63&c2)<<6|63&c3),n+=3);return t}},Base64:{encode:function(e){e=r.Utf8.encode(e);for(var n,o,s,a,i,u,l,c="",d=0,p=e.length,f=t.Const.BASE64;p>d;)n=e.charCodeAt(d++),o=e.charCodeAt(d++),s=e.charCodeAt(d++),a=n>>2,i=(3&n)<<4|o>>4,u=(15&o)<<2|s>>6,l=63&s,isNaN(o)?u=l=64:isNaN(s)&&(l=64),c=c+f.charAt(a)+f.charAt(i)+f.charAt(u)+f.charAt(l);return c},decode:function(e){e=e.replace(g,"");for(var t,n,o,s,a,i,u,l="",c=0,d=e.length;d>c;)s=keyString.indexOf(e.charAt(c++)),a=keyString.indexOf(e.charAt(c++)),i=keyString.indexOf(e.charAt(c++)),u=keyString.indexOf(e.charAt(c++)),t=s<<2|a>>4,n=(15&a)<<4|i>>2,o=(3&i)<<6|u,l+=p(t),64!=i&&(l+=p(n)),64!=u&&(l+=p(o));return l=r.Utf8.decode(l)}},Json:{encode:JSON.stringify,decode:JSON.parse},Url:{create:function(e){if(!e)return"";var t,n,o,s,u,l,c,d,p,f=[],h=a(e),g=h.length,C=r.Url.encode;for(s=0,t=g>s?[[n=h[s++],e[n]]]:[];t.length;){if(u=t.shift(),n=u[0],o=u[1],p=i.call(o),"[object Array]"===p)for(n+="[]",l=0,c=o.length;c>l;l++)t.unshift([n,o[l]]);else if("[object Object]"===p)for(d=a(o),l=0,c=d.length;c>l;l++)t.unshift([n+"["+d[l]+"]",o[d[l]]]);else f.push(C(n)+"="+C(o));!t.length&&g>s&&t.unshift([n=h[s++],e[n]])}return f.join("&")},rawencode:function(e){return encodeURIComponent(""+e).split("!").join("%21").split("'").join("%27").split("(").join("%28").split(")").join("%29").split("*").join("%2A")},rawdecode:function(e){return decodeURIComponent(""+e)},encode:function(e){return r.Url.rawencode(e).split("%20").join("+")},decode:function(e){return r.Url.rawdecode((""+e).split("+").join("%20"))}},Cookie:{create:function(e,t,n,r,o,s,a){var i=arguments.length;return{name:i>0?e:"",value:i>1?t:"",domain:i>2?n:"",path:i>3?r:"/",expires:i>4?o:new Date(Date.now()+31536e6),secure:i>5?!!s:!1,httponly:i>6?!!a:!1}},encode:function(e){if(e&&e.name){var t=String(e.name)+"="+String(e.value);return t+="; Domain="+String(e.domain),t+="; Path="+String(e.path),t+="; Expires="+String(e.expires),e.secure&&(t+="; Secure"),e.httponly&&(t+="; HttpOnly"),t}},decode:function(e){var n,o,a,i,u=r.Cookie.create(),l=t.Const.COOKIE_RE,c=String(e).split("; ");if(null!=(n=c.shift().match(l))){for(u.name=n[1],u.value=n[2],a=0,i=c.length;i>a;a++)n=c[a].match(l),null!=n&&n.length&&(o=n[1].toLowerCase(),u[s](o)&&(u[o]="string"==typeof n[2]?n[2]:!0));return"string"==typeof u.expires&&(u.expires=new Date(u.expires)),u}}},Header:{encode:function(e,n,r){var o="";if(!e)return xhr?xhr:o;var s,u,l,c,d,p=a(e),f=t.Const.CRLF;if(r){for(u=0,l=p.length;l>u;u++)s=p[u],r.setHeader(s,e[s]);return r}if(n){for(u=0,l=p.length;l>u;u++)if(s=p[u],"[object Array]"===i.call(e[s]))for(c=0,d=e[s].length;d>c;c++)n.setRequestHeader(s,String(e[s][c]));else n.setRequestHeader(s,String(e[s]));return n}for(u=0,l=p.length;l>u;u++)if(s=p[u],"[object Array]"===i.call(e[s]))for(o.length&&(o+=f),o+=s+": "+String(e[s][0]),c=1,d=e[s].length;d>c;c++)o+=f+String(e[s][c]);else o.length&&(o+=f),o+=s+": "+String(e[s]);return o},decode:function(e,n){var r,o,a,i,u={},l=null,c=t.Const.CRLF;if(e)for(n=!0===n,e=e.split(c),o=0,a=e.length;a>o;o++)i=e[o],r=i.split(":"),r.length>1?(l=h(r.shift()),n&&(l=l.toLowerCase()),u[s](l)?("string"==typeof u[l]&&(u[l]=[u[l]]),u[l].push(h(r.join(":")))):u[l]=h(r.join(":"))):r[0].length&&l&&(u[l]=c+r[0]);return u}}},t.Client=function y(e){var n=this;return n instanceof y?(n.$cfg$=e||{},n.$event$={},void(n.status=t.Client.CREATED)):new y(e)},t.Client.Impl={},t.Client.CREATED=1,t.Client.DESTROYED=0,t.Client.OPENED=2,t.Client.CLOSED=4,t.Client.PENDING=8,t.Client.ABORTED=16,t.Client[o]={constructor:t.Client,status:t.Client.CREATED,$cfg$:null,$event$:null,dispose:function(){var e=this;return e.status=t.Client.DESTROYED,e.$cfg$=null,e.$event$=null,e},config:function(e,t){var n=this,r=n.$cfg$;return e?arguments.length>1?(r[e]=t,n):r[e]:void 0},on:function(e,t,n){var r=this;return e&&t?(r.$event$[s](e)?r.$event$[e].push([t,!0===n,0]):r.$event$[e]=[[t,!0===n,0]],r):r},one:function(e,t){return this.on(e,t,!0)},off:function(e,t){var n=this;if(!e||!n.$event$[s](e))return n;if(null==t)delete n.$event$[e];else{for(var r=n.$event$[e],o=r.length-1;o>=0;o--)r[o][0]===t&&t.splice(o,1);r.length||delete n.$event$[e]}return n},emit:function(e,t){var n=this;if(!e||!n.$event$[s](e))return n;var r,o,a=n.$event$[e].slice(),i=a.length,u=[],l={event:e,data:t,target:n};for(r=0;i>r;r++)o=a[r],o[1]&&u.push(r),o[1]&&o[2]||(o[2]=1,o[0](l));for(a=n.$event$[e],r=u.length-1;r>=0;r--)a.splice(u[r],1);return a.length||delete n.$event$[e],n},abort:function(e,n){return this.status=t.Client.ABORTED,!0===e?this.emit("abort",n):this},open:function(e){return this.status=t.Client.OPENED,this.emit("open",e)},close:function(e){return this.status=t.Client.CLOSED,this.emit("close",e)},send:function(e){return this},listen:function(){return this},init:function(){var e=this;return setTimeout(function(){e.listen()},40),e}},t.Client[o].addEventListener=t.Client[o].on,t.Client[o].removeEventListener=t.Client[o].off,t.Client[o].trigger=t.Client[o].dispatchEvent=t.Client[o].emit,t});